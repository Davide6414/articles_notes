<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Article Note Saver - Dashboard</title>
    <style>
      :root{--bg:#fdfdfd;--panel:#ffffff;--muted:#556b6f;--text:#1a2b2c;--accent:#2e8b57;--accent2:#1e90ff;}
      *{box-sizing:border-box;transition:all .2s ease-in-out}
      body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
      .header{padding:20px;border-bottom:2px solid #cde;background:linear-gradient(90deg,var(--accent) 0%,var(--accent2) 100%);color:#fff}
      .header h1{margin:0;font-size:22px;font-weight:600}
      .tabs{display:flex;gap:10px;margin-top:12px}
      .tabs button{padding:8px 14px;border-radius:8px;background:#ffffff33;color:#fff;border:1px solid #ffffff55;cursor:pointer}
      .tabs button.active{background:#fff;color:var(--accent);font-weight:600}
      main{padding:20px}
      .filters{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
      .filters input,.filters select{padding:8px;border-radius:6px;border:1px solid #aac;background:#f0f8ff;color:var(--text)}
      .filters button{padding:8px 14px;border:0;border-radius:6px;background:var(--accent2);color:#fff;font-weight:600;cursor:pointer}
      .groups{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px}
      .group{background:var(--panel);border:1px solid #ccd;border-radius:12px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.1)}
      .group:hover{transform:scale(1.02);box-shadow:0 4px 12px rgba(0,0,0,.15)}
      .group h3{margin:0;padding:12px;border-bottom:1px solid #dde;font-size:15px;background:var(--accent);color:#fff}
      .item{padding:12px;border-top:1px dashed #ccd;font-size:13px;display:grid;grid-template-columns:84px 1fr;gap:10px;align-items:start}
      .item:first-child{border-top:0}
      .item a{color:var(--accent2);text-decoration:none;font-weight:600}
      .item a:hover{text-decoration:underline}
      .meta{color:var(--muted);font-size:12px;margin-top:4px}
      .tags{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
      .tag{font-size:11px;color:#fff;background:var(--accent2);padding:3px 7px;border-radius:10px}
      .thumb{width:84px;height:84px;border:1px solid #e5ecf0;border-radius:8px;object-fit:cover;background:#f7fafc}
      .noimg{width:84px;height:84px;border:1px dashed #e5ecf0;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;color:#94a3b8;background:#fbfdff}
      .actions-row{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      .btn{padding:8px 12px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
      .btn.primary{background:var(--accent2);color:#fff;border-color:var(--accent2)}
      /* Stato compattato */
      .item.collapsed{grid-template-columns:1fr}
      .item.collapsed .left-col{display:none}
      .item.collapsed .body .fulltext,
      .item.collapsed .body .linkwrap,
      .item.collapsed .body .ids{display:none}

      /* Overlay generico */
      .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:99999}
      .sheet{width:min(860px,94vw);max-height:min(85vh,900px);overflow:auto;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:14px}
      .sheet .hd{display:flex;gap:8px;align-items:center;margin-bottom:8px}
      .sheet .hd b{flex:1}
      .sheet .grid{display:grid;grid-template-columns:140px 1fr;gap:8px}
      .kv .k{font-weight:700}
      .kv .v{color:#1f2937}
      .imgwide{width:100%;max-height:300px;object-fit:cover;border-radius:10px;border:1px solid #e5ecf0;background:#f7fafc}

      /* Link widget (già esistente) */
      .link-widget{width:min(1100px,95vw);height:min(75vh,780px);background:#fff;border-radius:12px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.3);display:grid;grid-template-columns:1.3fr .7fr}
      .lw-header{grid-column:1/span 2;padding:10px 12px;background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;display:flex;align-items:center;gap:8px}
      .lw-header b{flex:1}
      .lw-left{border-right:1px solid #e5ecf0;padding:10px;overflow:auto}
      .lw-right{padding:10px;overflow:auto;display:flex;flex-direction:column}
      .lw-search{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:8px}
      .lw-list{margin-top:10px}
      .lw-item{border-bottom:1px solid #eef3f6;padding:8px}
      .lw-item:hover{background:#f7fafc}
      .muted{color:#6b7280;font-size:12px}
      .selected-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
      .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#eef6ff;border:1px solid #cbd5e1}

      /* Toast */
      .toast-container{position:fixed;top:16px;right:16px;display:flex;flex-direction:column;gap:8px;z-index:100000}
      .toast{min-width:240px;max-width:360px;background:#fff;border:1px solid #cbd5e1;border-left:4px solid var(--accent2);box-shadow:0 4px 16px rgba(0,0,0,.15);padding:10px 12px;border-radius:10px;font-size:13px;color:var(--text)}
      .toast.ok{border-left-color:#16a34a}
      .toast.err{border-left-color:#dc2626}
      .toast.info{border-left-color:var(--accent2)}
    </style>
  </head>
  <body>
    <header class="header">
      <h1>Article Note Saver - Dashboard</h1>
      <div class="tabs">
        <button id="tabNotes" class="active">Appunti</button>
        <button id="tabData">Dati</button>
      </div>
    </header>

    <main>
      <section id="notesPanel">
        <div class="filters">
          <input id="notesSearch" placeholder="Cerca testo/titolo/DOI" />
          <select id="notesTypeFilter"><option value="">Tutti i type</option></select>
          <select id="notesTagFilter"><option value="">Tutti i tag</option></select>
          <button id="notesExportCsv" title="Esporta gli appunti filtrati in CSV">Esporta CSV</button>
          <button id="generateIdsBtn" title="Assegna ID alle note senza ID">Genera ID</button>
          <button id="toggleAllCollapseBtn" title="Compatta/Espandi tutte">Toggle tutti</button>
        </div>
        <div id="notesGroups" class="groups"></div>
      </section>

      <section id="dataPanel" style="display:none;">
        <div class="filters">
          <input id="dataSearch" placeholder="Cerca per variabile/DOI" />
          <select id="dataVarFilter"><option value="">Tutte le variabili</option></select>
          <button id="dataExportCsv" title="Esporta i dati filtrati in CSV">Esporta CSV</button>
        </div>
        <div id="dataGroups" class="groups"></div>
      </section>
    </main>

    <!-- Overlay: Widget di linking -->
    <div id="linkOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Seleziona note da linkare">
      <div class="link-widget">
        <div class="lw-header">
          <b>Seleziona note da linkare</b>
          <button class="btn" id="lwCloseBtn" type="button">Chiudi</button>
        </div>
        <div class="lw-left">
          <input id="lwSearch" class="lw-search" placeholder="Cerca per titolo, testo, tag o note…" />
          <div id="lwList" class="lw-list"></div>
        </div>
        <div class="lw-right">
          <div>
            <div class="muted">Sorgente: <code id="lwSourceId"></code></div>
            <div class="muted" style="margin-top:6px;">Selezionati: <b id="lwCount">0</b></div>
            <div id="lwSelected" class="selected-list"></div>
          </div>
          <div class="actions-row">
            <button class="btn" id="lwCancelBtn" type="button">Annulla</button>
            <button class="btn primary" id="lwConfirmBtn" type="button">Linka</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay: Dettaglio singola nota -->
    <div id="detailOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Dettagli nota">
      <div class="sheet">
        <div class="hd">
          <b id="detTitle">(titolo)</b>
          <button class="btn" id="detCloseBtn" type="button">Chiudi</button>
        </div>
        <div id="detBody">
          <img id="detImg" class="imgwide" alt="" style="display:none">
          <div class="grid" style="margin-top:10px">
            <div class="kv k">ID</div><div class="kv v" id="detId"></div>
            <div class="kv k">DOI</div><div class="kv v" id="detDoi"></div>
            <div class="kv k">Type</div><div class="kv v" id="detType"></div>
            <div class="kv k">Tags</div><div class="kv v" id="detTags"></div>
            <div class="kv k">Nota</div><div class="kv v" id="detNote"></div>
            <div class="kv k">Link</div><div class="kv v" id="detLink"></div>
          </div>
          <div style="margin-top:12px">
            <div class="kv k">Testo</div>
            <div class="kv v" id="detText" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
      const DEFAULT_APPS_URL="https://script.google.com/macros/s/AKfycbyRXsW2jhj_NarPEyX5T8Yqf8U05qrZtPWReMwC9oW4dHTqXegnZhUmCwuYVmMXZ1uX/exec";
      const state={ notes:[], data:[] };
      const collapsed = new Set();      // ID note compattate
      let collapseAll=false;            // toggle globale

      // ---- INIT
      document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('tabNotes').onclick=()=>switchTab('notes');
        document.getElementById('tabData').onclick=()=>switchTab('data');

        document.getElementById('notesSearch').oninput=renderNotes;
        document.getElementById('notesTypeFilter').onchange=renderNotes;
        document.getElementById('notesTagFilter').onchange=renderNotes;
        document.getElementById('dataSearch').oninput=renderData;
        document.getElementById('dataVarFilter').onchange=renderData;

        document.getElementById('notesExportCsv').onclick=exportNotesCsv;
        document.getElementById('dataExportCsv').onclick=exportDataCsv;
        const genBtn=document.getElementById('generateIdsBtn'); if(genBtn) genBtn.onclick=generateIds;
        document.getElementById('toggleAllCollapseBtn').onclick=toggleAllCollapsed;

        // overlay controls
        document.getElementById('lwCloseBtn').onclick=closeLinkWidget;
        document.getElementById('lwCancelBtn').onclick=closeLinkWidget;
        document.getElementById('lwConfirmBtn').onclick=confirmLink;
        document.getElementById('detCloseBtn').onclick=closeDetail;
        document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ closeLinkWidget(); closeDetail(); } });

        loadAll();
      });

      // ---- LOAD
      async function loadAll(){
        try{
          const url=new URL(DEFAULT_APPS_URL); url.searchParams.set('mode','all');
          const res=await fetch(url.toString()); const json=await res.json();
          state.notes=Array.isArray(json.notes)?json.notes:[]; state.data=Array.isArray(json.data)?json.data:[];
        }catch(e){
          try{
            const url=new URL(DEFAULT_APPS_URL); url.searchParams.set('mode','all');
            const data=await jsonp(url.toString());
            state.notes=Array.isArray(data.notes)?data.notes:[]; state.data=Array.isArray(data.data)?data.data:[];
          }catch(e2){ console.error('Errore caricamento dati:',e2); showToast('Errore nel recupero dati dal server','err',5000); }
        }
        populateFilters(); renderNotes(); renderData();
      }

      // ---- UI helpers
      function switchTab(which){
        const nBtn=document.getElementById('tabNotes'), dBtn=document.getElementById('tabData');
        const nPanel=document.getElementById('notesPanel'), dPanel=document.getElementById('dataPanel');
        if(which==='data'){ nBtn.classList.remove('active'); dBtn.classList.add('active'); nPanel.style.display='none'; dPanel.style.display=''; }
        else { dBtn.classList.remove('active'); nBtn.classList.add('active'); dPanel.style.display='none'; nPanel.style.display=''; }
      }

      function populateFilters(){
        const typeSet=new Set(); state.notes.forEach(n=>{ if(n.Type) typeSet.add(String(n.Type)); });
        document.getElementById('notesTypeFilter').innerHTML='<option value="">Tutti i type</option>'+Array.from(typeSet).sort().map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

        const tagSet=new Set();
        state.notes.forEach(n=>{ String(n.Tags||'').split(',').forEach(t=>{ const v=t.trim(); if(v) tagSet.add(v); }); });
        document.getElementById('notesTagFilter').innerHTML='<option value="">Tutti i tag</option>'+Array.from(tagSet).sort((a,b)=>a.localeCompare(b,'it',{sensitivity:'base'})).map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

        const varSet=new Set(); state.data.forEach(d=>{ if(d.Variable) varSet.add(String(d.Variable)); });
        document.getElementById('dataVarFilter').innerHTML='<option value="">Tutte le variabili</option>'+Array.from(varSet).sort().map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      }

      function getFilteredNotes(){
        const search=document.getElementById('notesSearch').value.trim().toLowerCase();
        const typeFilter=document.getElementById('notesTypeFilter').value;
        const tagFilter=document.getElementById('notesTagFilter').value;
        return state.notes.filter(n=>{
          if(typeFilter && String(n.Type)!==typeFilter) return false;
          if(tagFilter){
            const tags=String(n.Tags||'').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
            if(!tags.includes(tagFilter.toLowerCase())) return false;
          }
          if(!search) return true;
          const hay=[n.Title,n.DOI,n.Text,n.URL,n.Link,n.Tags,n.Note,n.ImageLink].map(x=>String(x||'').toLowerCase()).join(' ');
          return hay.includes(search);
        });
      }

      function getFilteredData(){
        const search=document.getElementById('dataSearch').value.trim().toLowerCase();
        const varFilter=document.getElementById('dataVarFilter').value;
        return state.data.filter(d=>{
          if(varFilter && String(d.Variable)!==varFilter) return false;
          if(!search) return true;
          const hay=[d.Variable,d.DOI,d.URL,d.Notes,d.Unit].map(x=>String(x||'').toLowerCase()).join(' ');
          return hay.includes(search);
        });
      }

      // ---- RENDER NOTES (con bottoni: Linka, Visualizza linked, Dettagli, Compatta)
      function renderNotes(){
        const filtered=getFilteredNotes();
        const groups=groupBy(filtered,x=>String(x.DOI||'Senza DOI'));
        const container=document.getElementById('notesGroups'); container.innerHTML='';

        Object.keys(groups).sort().forEach(doi=>{
          const items=groups[doi];
          const title=items[0].Title||doi||'Senza titolo';
          const box=document.createElement('div'); box.className='group';
          box.innerHTML=`<h3>${escapeHtml(title)} <span class="meta">(${items.length})</span></h3>`;

          items.forEach(item=>{
            const id=String(item.ID||''); const linked=String(item.LinkedIDs||'');
            const tags=String(item.Tags||'').split(',').map(t=>t.trim()).filter(Boolean);
            const link=String(item.Link||item.URL||'');
            const noteText=String(item.Note||''); const img=String(item.ImageLink||'');

            const div=document.createElement('div'); div.className='item'+(collapsed.has(id)||collapseAll?' collapsed':'');
            const left = `<div class="left-col">${img?`<a href="${escapeAttr(img)}" target="_blank" title="Apri immagine"><img class="thumb" src="${escapeAttr(img)}" alt="img ${escapeAttr(id)}"></a>`:`<div class="noimg">no img</div>`}</div>`;

            const body = `
              <div class="body">
                <div><b>${escapeHtml(String(item.Type||'Senza tipo'))}</b> — <span>${escapeHtml(item.Title||'(senza titolo)')}</span></div>
                <div class="meta">DOI: ${escapeHtml(String(item.DOI||''))}</div>
                <div class="fulltext">${escapeHtml(String(item.Text||''))}</div>
                ${tags.length?`<div class="tags">${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>`:''}
                ${noteText?`<div class="meta"><b>Nota:</b> ${escapeHtml(noteText)}</div>`:''}
                <div class="linkwrap meta">${link?`<a href="${escapeAttr(link)}" target="_blank">Apri sorgente</a>`:''}</div>
                <div class="ids meta">ID: <code>${escapeHtml(id||'(manca)')}</code> · Linked: ${escapeHtml(linked)}</div>
                <div class="actions-row">
                  <button class="btn" data-open-linker ${id?'':'disabled'}>${id?'Linka…':'Genera ID per abilitare'}</button>
                  ${id?`<a class="btn" href="linked.html?id=${encodeURIComponent(id)}" target="_blank" rel="noopener">Visualizza linked</a>`:`<button class="btn" disabled>Visualizza linked</button>`}
                  ${id?`<button class="btn" data-details="${escapeAttr(id)}">Dettagli</button>`:`<button class="btn" disabled>Dettagli</button>`}
                  ${id?`<button class="btn" data-collapse="${escapeAttr(id)}">${(collapsed.has(id)||collapseAll)?'Espandi':'Compatta'}</button>`:`<button class="btn" disabled>Compatta</button>`}
                </div>
              </div>`;

            div.innerHTML = left + body;

            const openBtn=div.querySelector('[data-open-linker]'); if(openBtn) openBtn.onclick=()=>openLinkWidget(item);
            const detBtn =div.querySelector('[data-details]');   if(detBtn)  detBtn.onclick=()=>openDetail(item);
            const colBtn =div.querySelector('[data-collapse]');  if(colBtn)  colBtn.onclick=(e)=>toggleCollapsed(id,e.currentTarget,div);

            box.appendChild(div);
          });

          container.appendChild(box);
        });
      }

      function toggleCollapsed(id, btn, itemEl){
        if(collapseAll){
          collapseAll=false;
          collapsed.clear();
        }else{
          if(collapsed.has(id)) collapsed.delete(id); else collapsed.add(id);
        }
        if(itemEl){
          itemEl.classList.toggle('collapsed', collapsed.has(id));
          btn.textContent = itemEl.classList.contains('collapsed') ? 'Espandi' : 'Compatta';
        }else{
          renderNotes();
        }
      }

      function toggleAllCollapsed(){
        collapseAll=!collapseAll;
        if(collapseAll){ // marca tutti gli ID attualmente filtrati
          collapsed.clear();
          getFilteredNotes().forEach(n=>{ if(n.ID) collapsed.add(String(n.ID)); });
        }else{
          collapsed.clear();
        }
        renderNotes();
      }

      // ---- DATA RENDER
      function renderData(){
        const filtered=getFilteredData();
        const groups=groupBy(filtered,x=>String(x.Variable||'Senza variabile'));
        const container=document.getElementById('dataGroups'); container.innerHTML='';
        Object.keys(groups).sort().forEach(variable=>{
          const box=document.createElement('div'); box.className='group';
          box.innerHTML=`<h3>${escapeHtml(variable)} <span class="meta">(${groups[variable].length})</span></h3>`;
          groups[variable].forEach(item=>{
            const link=String(item.Link||item.URL||''); const a=link?`<a href="${escapeAttr(link)}" target="_blank">Apri</a>`:'';
            const val=String(item.Value||''); const unit=String(item.Unit||''); const mean=String(item.Mean||''); const std=String(item.StdDev||''); const n=String(item.N||'');
            const div=document.createElement('div'); div.className='item'; div.style.gridTemplateColumns='1fr';
            div.innerHTML=`
              <div><b>${escapeHtml(val)} ${escapeHtml(unit)}</b> <span class="meta">N=${escapeHtml(n)} mean=${escapeHtml(mean)} sd=${escapeHtml(std)}</span></div>
              <div class="meta">DOI: ${escapeHtml(String(item.DOI||''))}</div>
              <div>${escapeHtml(String(item.Notes||''))}</div>
              <div class="meta">${a}</div>`;
            box.appendChild(div);
          });
          container.appendChild(box);
        });
      }

      // ---- DETAIL SHEET
      function openDetail(item){
        if(!item) return;
        document.getElementById('detTitle').textContent = String(item.Title||'(senza titolo)');
        document.getElementById('detId').textContent    = String(item.ID||'');
        document.getElementById('detDoi').textContent   = String(item.DOI||'');
        document.getElementById('detType').textContent  = String(item.Type||'');
        document.getElementById('detTags').textContent  = String(item.Tags||'');
        document.getElementById('detNote').textContent  = String(item.Note||'');
        document.getElementById('detText').textContent  = String(item.Text||'');
        const link = String(item.Link||item.URL||'');
        document.getElementById('detLink').innerHTML = link ? `<a href="${escapeAttr(link)}" target="_blank" rel="noopener">${escapeHtml(link)}</a>` : '';
        const img = String(item.ImageLink||'');
        const imgEl = document.getElementById('detImg');
        if(img){ imgEl.src=img; imgEl.style.display='block'; imgEl.alt='Immagine '+String(item.ID||''); } else { imgEl.removeAttribute('src'); imgEl.style.display='none'; }
        document.getElementById('detailOverlay').style.display='flex';
      }
      function closeDetail(){ document.getElementById('detailOverlay').style.display='none'; }

      // ---- GROUP BY
      function groupBy(arr,keyFn){ return arr.reduce((acc,x)=>{ const k=keyFn(x); (acc[k] ||= []).push(x); return acc; },{}); }

      // ---- CSV
      const NOTES_HEADERS=['CreatedAt','URL','Link','Title','DOI','Text','Tags','Type','ClientTimestamp','ID','LinkedIDs','Note','ImageLink'];
      const DATA_HEADERS=['CreatedAt','DOI','URL','Link','Variable','Value','Unit','N','Mean','StdDev','Notes','ClientTimestamp'];

      function exportNotesCsv(){ const rows=getFilteredNotes(); const csv=toCsv(rows,NOTES_HEADERS); downloadCsv(csv,`notes_${timestamp()}.csv`); }
      function exportDataCsv(){ const rows=getFilteredData(); const csv=toCsv(rows,DATA_HEADERS); downloadCsv(csv,`data_${timestamp()}.csv`); }

      function toCsv(rows,headers){
        const esc=v=>'"'+String(v==null?'':v).replace(/"/g,'""')+'"';
        const lines=[headers.map(h=>'"'+h+'"').join(',')];
        for(const r of rows){ lines.push(headers.map(h=>esc(r[h])).join(',')); }
        return lines.join('\r\n');
      }
      function downloadCsv(text,filename){
        const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }

      // ---- Utils
      function timestamp(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`; }
      function escapeHtml(str){ return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
      function escapeAttr(str){ return escapeHtml(str).replace(/"/g,'&quot;'); }

      // ---- JSONP
      function jsonp(baseUrl){
        return new Promise((resolve,reject)=>{
          try{
            const url=new URL(baseUrl); const cb='cb_'+Math.random().toString(36).slice(2);
            url.searchParams.set('callback',cb);
            const s=document.createElement('script'); let done=false;
            window[cb]=(data)=>{ done=true; cleanup(); resolve(data); };
            s.src=url.toString(); s.onerror=(e)=>{ cleanup(); reject(e); };
            document.body.appendChild(s);
            const t=setTimeout(()=>{ if(!done){ cleanup(); reject(new Error('JSONP timeout')); } },12000);
            function cleanup(){ try{ delete window[cb]; }catch{} try{ s.remove(); }catch{} clearTimeout(t); }
          }catch(err){ reject(err); }
        });
      }

      // ---- Toast
      function showToast(message,kind='info',timeout=3000){
        try{
          const c=document.getElementById('toastContainer'); if(!c) return alert(message);
          const el=document.createElement('div'); el.className='toast '+(kind||'info'); el.textContent=String(message);
          c.appendChild(el); const t=setTimeout(()=>{ try{ el.remove(); }catch{} }, timeout||3000);
          el.addEventListener('click',()=>{ clearTimeout(t); try{ el.remove(); }catch{} });
        }catch(e){ console.warn('toast error',e); }
      }

      // ---- Link widget logic (persistenza server)
      let linkOrigin=null, linkSelection=new Set();

      function openLinkWidget(item){
        if(!item||!item.ID) return;
        linkOrigin=item;
        linkSelection=new Set(String(item.LinkedIDs||'').split(',').map(s=>s.trim()).filter(Boolean));
        document.getElementById('lwSourceId').textContent=String(item.ID);
        document.getElementById('lwSearch').value=''; renderLinkList();
        document.getElementById('linkOverlay').style.display='flex';
        setTimeout(()=>document.getElementById('lwSearch').focus(),0);
        document.getElementById('lwSearch').oninput=renderLinkList;
      }
      function closeLinkWidget(){
        document.getElementById('linkOverlay').style.display='none';
        document.getElementById('lwList').innerHTML=''; document.getElementById('lwSelected').innerHTML=''; document.getElementById('lwCount').textContent='0';
        linkOrigin=null; linkSelection.clear();
      }
      function renderLinkList(){
        const q=document.getElementById('lwSearch').value.trim().toLowerCase();
        const list=document.getElementById('lwList'); list.innerHTML='';
        state.notes.forEach(n=>{
          const id=String(n.ID||''); if(!id) return; if(linkOrigin && id===String(linkOrigin.ID)) return;
          const hay=[n.Title,n.Text,n.Tags,n.Note,n.ImageLink].map(x=>String(x||'').toLowerCase()).join(' ');
          if(q && !hay.includes(q)) return;
          const checked=linkSelection.has(id)?'checked':'';
          const tagsHtml=String(n.Tags||'').split(',').map(t=>t.trim()).filter(Boolean).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ');
          const img=String(n.ImageLink||''); const imgHtml=img?`<img class="thumb" src="${escapeAttr(img)}" alt="img ${escapeAttr(id)}">`:`<div class="noimg">no img</div>`;
          const div=document.createElement('div'); div.className='lw-item';
          div.innerHTML=`
            <label style="display:grid;grid-template-columns:24px 72px 1fr;gap:8px;align-items:flex-start;">
              <input class="lw-check" type="checkbox" value="${escapeAttr(id)}" ${checked} style="margin-top:6px;">
              <div>${imgHtml}</div>
              <div>
                <div class="t">${escapeHtml(n.Title||'(senza titolo)')}</div>
                <div class="muted">${escapeHtml(n.Text||'')}</div>
                ${n.Note?`<div class="muted"><b>Nota:</b> ${escapeHtml(n.Note)}</div>`:''}
                ${tagsHtml?`<div class="tags" style="margin-top:6px;">${tagsHtml}</div>`:''}
                <div class="muted" style="margin-top:6px;">ID: <code>${escapeHtml(id)}</code></div>
              </div>
            </label>`;
          list.appendChild(div);
        });
        list.onchange=(e)=>{
          const t=e.target; if(t && t.classList.contains('lw-check')){ const id=String(t.value); if(t.checked) linkSelection.add(id); else linkSelection.delete(id); updateSelectedPreview(); }
        };
        updateSelectedPreview();
      }
      function updateSelectedPreview(){
        const sel=Array.from(linkSelection);
        document.getElementById('lwCount').textContent=String(sel.length);
        document.getElementById('lwSelected').innerHTML=sel.map(id=>`<span class="pill">ID ${escapeHtml(id)}</span>`).join(' ');
      }
      async function confirmLink(){
        if(!linkOrigin||!linkOrigin.ID){ closeLinkWidget(); return; }
        const checked=Array.from(linkSelection);
        showToast('Invio dei link al server…','info',2000);
        try{
          const url=new URL(DEFAULT_APPS_URL); url.searchParams.set('mode','updateLinks'); url.searchParams.set('id',String(linkOrigin.ID)); url.searchParams.set('linkedIds',checked.join(','));
          const res=await jsonp(url.toString());
          if(!res||res.ok!==true){ showToast('Errore: risposta non valida dal server','err',5000); return; }
          await loadAll(); closeLinkWidget(); showToast('Link salvati sul server','ok',3500);
        }catch(err){ console.error('confirmLink error',err); showToast('Errore di rete durante il salvataggio','err',5000); }
      }

      // ---- Server utils
      async function generateIds(){
        try{
          if(!confirm('Assegnare un ID alle note senza ID?')) return;
          const url=new URL(DEFAULT_APPS_URL); url.searchParams.set('mode','assignIds');
          const data=await jsonp(url.toString());
          const assigned=data&&typeof data.assigned==='number'?data.assigned:null;
          showToast(typeof assigned==='number'?`Assegnati ${assigned} ID`:'Assegnazione ID completata','ok',3500);
          await loadAll();
        }catch(e){ console.error('Errore generateIds',e); showToast('Errore durante la generazione degli ID','err',5000); }
      }
    </script>
  </body>
</html>
