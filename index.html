<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Article Note Saver - Appunti</title>
    <style>
      :root {
        --bg: #f6f7fb; --panel: #ffffff; --muted: #64748b; --text: #0f172a;
        --accent: #2563eb; --accent2: #10b981; --ring: #93c5fd;
        --border: #e5e7eb; --border-strong: #cbd5e1;
      }
      *{ box-sizing:border-box; transition:all .18s ease; }
      html,body{ height:100%; }
      body{
        margin:0; font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
        background: radial-gradient(1200px 800px at 20% -10%, #eef2ff 0%, #f8fafc 40%, var(--bg) 100%);
        color:var(--text); line-height:1.55; letter-spacing:.1px;
      }
      :focus-visible{ outline:3px solid var(--ring); outline-offset:2px; border-radius:10px; }

      .header{
        padding:22px; border-bottom:1px solid #dbeafe;
        background:
          linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)) 0 0/100% 100%,
          linear-gradient(90deg, var(--accent) 0%, var(--accent2) 100%);
        color:#fff;
      }
      .header h1{ margin:0; font-size:24px; font-weight:800; letter-spacing:.2px; }
      .tabs{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
      .tabs button{
        padding:10px 16px; border-radius:999px; background:#ffffff2b;
        color:#fff; border:1px solid #ffffff55; cursor:pointer; font-size:14px; backdrop-filter: blur(2px);
      }
      .tabs button:hover{ background:#ffffff45; }
      .tabs button.active{ background:#fff; color:var(--accent); font-weight:700; }

      main{ padding:24px 28px; max-width:none; margin:0; }

      .filters{
        display:grid;
        grid-template-columns:1fr repeat(2, minmax(180px, 240px)) auto auto;
        gap:12px; margin-bottom:20px;
      }
      @media (max-width:980px){ .filters{ grid-template-columns:1fr 1fr; } }
      .filters input, .filters select{
        padding:10px 12px; border-radius:10px; border:1px solid var(--border);
        background:#fff; color:var(--text); font-size:14px; box-shadow:0 1px 0 rgba(0,0,0,.02);
      }
      .filters input::placeholder{ color:#94a3b8; }
      .filters button{
        padding:10px 14px; border:1px solid var(--border-strong); border-radius:10px;
        background:#fff; color:var(--text); font-weight:600; cursor:pointer; font-size:14px;
      }
      .filters button:hover{ background:#f3f4f6; }
      .filters #notesExportCsv{ background:var(--accent); border-color:var(--accent); color:#fff; }
      .filters #notesExportCsv:hover{ background:#1d4ed8; }

      .groups{ display:flex; flex-direction:column; gap:22px; width:100%; }
      .group{
        width:100%; background:var(--panel); border:1px solid var(--border);
        border-radius:16px; overflow:hidden;
        box-shadow:0 1px 0 rgba(15,23,42,0.02), 0 10px 24px -18px rgba(2,6,23,0.3);
      }
      .group:hover{ transform:translateY(-2px); box-shadow:0 14px 30px -14px rgba(2,6,23,.35); }
      .group h3{
        margin:0; padding:14px 16px; border-bottom:1px solid var(--border);
        font-size:16px; font-weight:700;
        background: linear-gradient(90deg, var(--accent) 0%, var(--accent2) 100%);
        color:#fff; display:flex; gap:8px; align-items:center; justify-content:space-between;
      }
      .group h3 .meta{
        font-weight:600; opacity:.95; font-size:12px; padding:2px 8px;
        background:#ffffff2b; border:1px solid #ffffff55; border-radius:999px;
      }

      .items-grid{
        display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
        grid-auto-rows:1fr; gap:14px; padding:12px; align-items:stretch;
      }

      .note-card{
        background:#fff; border:1px solid #e5e7eb; border-radius:12px;
        box-shadow:0 2px 8px rgba(0,0,0,.06); overflow:hidden; display:flex; flex-direction:column; height:100%;
        border-left:4px solid var(--type-color, var(--border-strong));
        background: linear-gradient(0deg, var(--type-bg, transparent), var(--type-bg, transparent)), #fff;
      }
      .note-card:hover{ transform:translateY(-2px); box-shadow:0 8px 22px rgba(0,0,0,.09); }
      .note-card .thumb{ width:100%; height:140px; border-radius:0; margin:0; object-fit:cover; }
      .note-card .card-body{ padding:12px; display:flex; flex-direction:column; gap:8px; flex:1; }
      .note-card .title-row{ font-size:14px; font-weight:800; line-height:1.25 }
      .note-card .type{
        font-size:11px; font-weight:800; text-transform:uppercase; letter-spacing:.3px;
        color: var(--type-color, #2563eb);
        background: var(--type-pill-bg, #eef6ff);
        border: 1px solid var(--type-color, #2563eb);
        padding: 2px 6px; border-radius: 9999px;
      }
      .note-card .meta{ color:#6b7280; font-size:12px }
      .note-card .fulltext{ font-size:13px; color:#0f172a }
      .note-card .note-box{
        background: var(--type-pill-bg, #eef6ff); border:1px solid var(--type-color, #93c5fd);
        border-left-width:4px; padding:8px 10px; border-radius:10px; color:#0b1220;
      }
      .note-card .text-box{ background:#f8fafc; border:1px solid var(--border); padding:8px 10px; border-radius:10px; }
      .note-card .tags{ display:flex; gap:6px; flex-wrap:wrap }
      .note-card .tag{ font-size:11px; color:#0b1220; background:#ecfeff; padding:3px 8px; border-radius:999px; border:1px solid #bae6fd }
      .note-card .animal-tag{ font-size:11px; background:#fff7ed; border:1px solid #fed7aa; color:#9a3412; padding:3px 8px; border-radius:999px }
      .note-card .actions-row{ margin:0 12px 12px; display:flex; gap:8px; flex-wrap:wrap }
      .note-card .btn{ padding:6px 10px; font-size:12px; border-radius:8px; border:1px solid #d1d5db; background:#fff; cursor:pointer }
      .note-card .btn:hover{ background:#f3f4f6 }
      .note-card .btn.primary{ background:#2563eb; color:#fff; border-color:#2563eb }

      .note-card.collapsed .fulltext,
      .note-card.collapsed .linkwrap,
      .note-card.collapsed .ids{ display:none }

      .clamp-2{ display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:2; overflow:hidden; }
      .clamp-3{ display:-webkit-box; -webkit-box-orient:vertical; -webkit-line-clamp:3; overflow:hidden; }
      .linkwrap a{ color:#0ea5e9; text-decoration:none; font-weight:700; }
      .linkwrap a:hover{ text-decoration:underline; }
      .ids{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }

      .btn{ padding:8px 14px; border-radius:10px; border:1px solid var(--border-strong); background:#fff; cursor:pointer; font-size:13px; font-weight:600; }
      .btn:hover{ background:#f3f4f6; }
      .btn[disabled]{ opacity:.5; cursor:not-allowed; }
      .btn.primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
      .btn.primary:hover{ background:#1d4ed8; }

      .overlay{ position:fixed; inset:0; background:rgba(2,6,23,.52); display:none; align-items:center; justify-content:center; z-index:99999; }
      .sheet{
        width:min(880px,96vw); max-height:min(86vh,900px); overflow:auto; background:#fff; border-radius:16px;
        box-shadow:0 14px 40px rgba(2, 6, 23, .36); padding:18px; border-top:6px solid var(--type-color, var(--accent));
      }
      .sheet .hd{ display:flex; gap:12px; align-items:center; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid var(--border); }
      .sheet .hd b{ flex:1; font-size:18px; }
      .sheet .grid{ display:grid; grid-template-columns:160px 1fr; gap:10px; }
      .kv .k{ font-weight:800; color:#0b1220; }
      .kv .v{ color:#1f2937; }
      .imgwide{ width:100%; max-height:320px; object-fit:cover; border-radius:12px; border:1px solid var(--border); background:#f7fafc; margin-bottom:10px; }
      #detNote{ background: var(--type-pill-bg, #eef6ff); border:1px solid var(--type-color, #93c5fd); border-left-width:4px; padding:8px 10px; border-radius:10px; }
      #detText{ background:#f8fafc; border:1px solid var(--border); padding:10px 12px; border-radius:12px; white-space:pre-wrap; }

      .link-widget{
        width:min(1100px,96vw); height:min(78vh,820px);
        background:#fff; border-radius:16px; overflow:hidden; box-shadow:0 14px 40px rgba(2,6,23,.36);
        display:grid; grid-template-columns:1.2fr .8fr;
      }
      .lw-header{ grid-column:1 / span 2; padding:12px 14px; background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#fff; display:flex; align-items:center; gap:8px; }
      .lw-header b{ flex:1; }
      .lw-left{ border-right:1px solid var(--border); padding:10px; overflow:auto; }
      .lw-right{ padding:10px; overflow:auto; display:flex; flex-direction:column; }
      .lw-search{ width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; }
      .lw-list{ margin-top:10px; }
      .lw-item{ border-bottom:1px solid #eef3f6; padding:10px; }
      .lw-item:hover{ background:#f8fafc; }
      .muted{ color:#6b7280; font-size:12px; }
      .selected-list{ display:flex; flex-direction:column; gap:6px; margin-top:8px; }
      .pill{ display:inline-block; font-size:12px; padding:4px 8px; border-radius:999px; background:#eef6ff; border:1px solid var(--border-strong); }

      .toast-container{ position:fixed; top:16px; right:16px; display:flex; flex-direction:column; gap:8px; z-index:100000; }
      .toast{
        min-width:260px; max-width:380px; background:#fff; border:1px solid var(--border-strong);
        border-left:6px solid var(--accent); box-shadow:0 6px 20px rgba(2,6,23,.18);
        padding:12px 14px; border-radius:12px; font-size:14px; color:var(--text);
      }
      .toast.ok{ border-left-color:#16a34a; }
      .toast.err{ border-left-color:#dc2626; }
      .toast.info{ border-left-color:var(--accent); }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>Article Note Saver — Appunti</h1>
      <div class="tabs" role="tablist" aria-label="Sezioni">
        <button id="tabNotes" class="active" role="tab" aria-selected="true" aria-controls="notesPanel">Appunti</button>
        <button id="openDataPageBtn" type="button" title="Apri pagina dati (nuova scheda)">Dati ↗</button>
      </div>
    </header>

    <main>
      <section id="notesPanel" role="tabpanel" aria-labelledby="tabNotes">
        <div class="filters">
          <input id="notesSearch" placeholder="Cerca testo / titolo / DOI" aria-label="Cerca nelle note" />
          <select id="notesTypeFilter" aria-label="Filtra per Type"><option value="">Tutti i type</option></select>
          <select id="notesTagFilter" aria-label="Filtra per Tag"><option value="">Tutti i tag</option></select>
          <button id="notesExportCsv" title="Esporta gli appunti filtrati in CSV">Esporta CSV</button>
          <button id="generateIdsBtn" title="Assegna ID alle note senza ID">Genera ID</button>
          <button id="toggleAllCollapseBtn" title="Compatta/Espandi tutte">Toggle tutti</button>
        </div>
        <div id="notesGroups" class="groups" aria-live="polite"></div>
      </section>
    </main>

    <!-- Overlay: Widget di linking -->
    <div id="linkOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Seleziona note da linkare">
      <div class="link-widget">
        <div class="lw-header">
          <b>Seleziona note da linkare</b>
          <button class="btn" id="lwCloseBtn" type="button">Chiudi</button>
        </div>
        <div class="lw-left">
          <input id="lwSearch" class="lw-search" placeholder="Cerca per titolo, testo, tag o note…" />
          <div id="lwList" class="lw-list"></div>
        </div>
        <div class="lw-right">
          <div>
            <div class="muted">Sorgente: <code id="lwSourceId"></code></div>
            <div class="muted" style="margin-top:6px;">Selezionati: <b id="lwCount">0</b></div>
            <div id="lwSelected" class="selected-list"></div>
          </div>
          <div class="actions-row">
            <button class="btn" id="lwCancelBtn" type="button">Annulla</button>
            <button class="btn primary" id="lwConfirmBtn" type="button">Linka</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Overlay: Dettaglio singola nota -->
    <div id="detailOverlay" class="overlay" role="dialog" aria-modal="true" aria-label="Dettagli nota">
      <div class="sheet">
        <div class="hd">
          <b id="detTitle">(titolo)</b>
          <span id="detTypePill" class="pill" style="border-color:var(--type-color); background:var(--type-pill-bg);"></span>
          <button class="btn" id="detCloseBtn" type="button">Chiudi</button>
        </div>
        <div id="detBody">
          <img id="detImg" class="imgwide" alt="" style="display:none">
          <div class="grid" style="margin-top:10px">
            <div class="kv k">ID</div><div class="kv v" id="detId"></div>
            <div class="kv k">DOI</div><div class="kv v" id="detDoi"></div>
            <div class="kv k">Type</div><div class="kv v" id="detType"></div>
            <div class="kv k">Tags</div><div class="kv v" id="detTags"></div>
            <div class="kv k">Nota</div><div class="kv v" id="detNote"></div>
            <div class="kv k">Link</div><div class="kv v" id="detLink"></div>
          </div>
          <div style="margin-top:12px">
            <div class="kv k">Testo</div>
            <div class="kv v" id="detText" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="toastContainer" class="toast-container" aria-live="polite" aria-atomic="true"></div>

    <script>
      const DEFAULT_APPS_URL="https://script.google.com/macros/s/AKfycbyRXsW2jhj_NarPEyX5T8Yqf8U05qrZtPWReMwC9oW4dHTqXegnZhUmCwuYVmMXZ1uX/exec";
      const state={ notes:[], data:[] };
      const collapsed=new Set(); let collapseAll=false;

      document.addEventListener('DOMContentLoaded', ()=>{
        const tabNotes=document.getElementById('tabNotes');
        if(tabNotes) tabNotes.onclick=()=>switchTab('notes');

        const openDataBtn=document.getElementById('openDataPageBtn');
        if(openDataBtn) openDataBtn.onclick=()=>window.open('data.html','_blank','noopener');

        const notesSearch=document.getElementById('notesSearch');
        if(notesSearch) notesSearch.oninput=renderNotes;

        const notesTypeFilter=document.getElementById('notesTypeFilter');
        if(notesTypeFilter) notesTypeFilter.onchange=renderNotes;

        const notesTagFilter=document.getElementById('notesTagFilter');
        if(notesTagFilter) notesTagFilter.onchange=renderNotes;

        const notesExportCsv=document.getElementById('notesExportCsv');
        if(notesExportCsv) notesExportCsv.onclick=exportNotesCsv;

        const genBtn=document.getElementById('generateIdsBtn');
        if(genBtn) genBtn.onclick=generateIds;

        const toggleAllCollapseBtn=document.getElementById('toggleAllCollapseBtn');
        if(toggleAllCollapseBtn) toggleAllCollapseBtn.onclick=toggleAllCollapsed;

        const lwCloseBtn=document.getElementById('lwCloseBtn');
        if(lwCloseBtn) lwCloseBtn.onclick=closeLinkWidget;

        const lwCancelBtn=document.getElementById('lwCancelBtn');
        if(lwCancelBtn) lwCancelBtn.onclick=closeLinkWidget;

        const lwConfirmBtn=document.getElementById('lwConfirmBtn');
        if(lwConfirmBtn) lwConfirmBtn.onclick=confirmLink;

        const detCloseBtn=document.getElementById('detCloseBtn');
        if(detCloseBtn) detCloseBtn.onclick=closeDetail;

        document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ closeLinkWidget(); closeDetail(); } });

        loadAll();
      });

      async function loadAll(){
        try{
          const url=new URL(DEFAULT_APPS_URL); url.searchParams.set('mode','all');
          const res=await fetch(url.toString()); const json=await res.json();
          state.notes=Array.isArray(json.notes)?json.notes:[]; state.data=Array.isArray(json.data)?json.data:[];
        }catch(e){
          try{
            const url=new URL(DEFAULT_APPS_URL); url.searchParams.set('mode','all');
            const data=await jsonp(url.toString());
            state.notes=Array.isArray(data.notes)?data.notes:[]; state.data=Array.isArray(data.data)?data.data:[];
          }catch(e2){ console.error('Errore caricamento dati:',e2); showToast('Errore nel recupero dati dal server','err',5000); }
        }
        populateFilters(); renderNotes();
      }

      function switchTab(which){
        // Solo se in futuro reintrodurrai più pannelli in questa pagina
        if(which!=='notes') return;
      }

      function populateFilters(){
        const typeSet=new Set(); state.notes.forEach(n=>{ if(n.Type) typeSet.add(String(n.Type)); });
        const typeSel=document.getElementById('notesTypeFilter');
        if(typeSel){
          typeSel.innerHTML='<option value="">Tutti i type</option>'+Array.from(typeSet).sort().map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
        }

        const tagSet=new Set();
        state.notes.forEach(n=>{
          String(n.Tags||'').split(',').forEach(t=>{ const v=t.trim(); if(v) tagSet.add(v); });
          const animal=String(n.Animal||'').trim(); if(animal) tagSet.add(animal);
        });
        const tagSel=document.getElementById('notesTagFilter');
        if(tagSel){
          tagSel.innerHTML='<option value="">Tutti i tag</option>'+Array.from(tagSet)
            .sort((a,b)=>a.localeCompare(b,'it',{sensitivity:'base'}))
            .map(t=>`<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
        }
      }

      function getFilteredNotes(){
        const searchEl=document.getElementById('notesSearch');
        const typeEl=document.getElementById('notesTypeFilter');
        const tagEl=document.getElementById('notesTagFilter');
        const search=(searchEl?searchEl.value:'').trim().toLowerCase();
        const typeFilter=typeEl?typeEl.value:'';
        const tagFilter=tagEl?tagEl.value:'';
        return state.notes.filter(n=>{
          if(typeFilter && String(n.Type)!==typeFilter) return false;
          if(tagFilter){
            const tags=String(n.Tags||'').split(',').map(t=>t.trim().toLowerCase()).filter(Boolean);
            const animal=String(n.Animal||'').trim().toLowerCase(); if(animal) tags.push(animal);
            if(!tags.includes(tagFilter.toLowerCase())) return false;
          }
          if(!search) return true;
          const hay=[n.Title,n.DOI,n.Text,n.URL,n.Link,n.Tags,n.Note,n.ImageLink,n.Animal].map(x=>String(x||'').toLowerCase()).join(' ');
          return hay.includes(search);
        });
      }

      function renderNotes(){
        const filtered=getFilteredNotes();
        const groups=groupBy(filtered,x=>String(x.DOI||'Senza DOI'));
        const container=document.getElementById('notesGroups'); if(!container) return;
        container.innerHTML='';

        Object.keys(groups).sort().forEach(doi=>{
          const items=groups[doi];
          const title=items[0].Title||doi||'Senza titolo';

          const box=document.createElement('div'); box.className='group';
          box.innerHTML=`<h3><span class="clamp-2" style="max-width:82%">${escapeHtml(title)}</span> <span class="meta">${items.length}</span></h3>`;

          const grid=document.createElement('div'); grid.className='items-grid';

          items.sort((a,b)=>{
            const ta=String(a.Type||'').toLowerCase();
            const tb=String(b.Type||'').toLowerCase();
            if(ta<tb) return -1; if(ta>tb) return 1;
            return String(a.ID||'').localeCompare(String(b.ID||''));
          });

          items.forEach(item=>{
            const id=String(item.ID||''); const tags=String(item.Tags||'').split(',').map(t=>t.trim()).filter(Boolean);
            const link=String(item.Link||item.URL||''); const noteText=String(item.Note||'');
            const img=String(item.ImageLink||''); const animal=String(item.Animal||'').trim();

            const card=document.createElement('div');
            card.className='note-card'+(collapsed.has(id)||collapseAll?' collapsed':'');
            card.setAttribute('data-id', id);

            const imgHtml = img ? `<img class="thumb" src="${escapeAttr(img)}" alt="img ${escapeAttr(id)}">` : ``;

            card.innerHTML = `
              <div class="title-row">
                <span class="type">${escapeHtml(String(item.Type||'SENZA TIPO'))}</span>
              </div>
              ${imgHtml}
              <div class="card-body">
                <div class="meta">DOI: ${escapeHtml(String(item.DOI||''))}</div>
                ${noteText?`<div class="note-box">${escapeHtml(noteText)}</div>`:''}
                <div class="fulltext clamp-3 text-box">${escapeHtml(String(item.Text||''))}</div>
                ${(animal||tags.length)?`<div class="tags">${animal?`<span class="tag animal-tag">🐾 ${escapeHtml(animal)}</span>`:''}${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>`:''}
                <div class="linkwrap meta">${link?`<a href="${escapeAttr(link)}" target="_blank" rel="noopener">Apri sorgente</a>`:''}</div>
              </div>
              <div class="actions-row">
                <button class="btn" data-open-linker ${id?'':'disabled'}>${id?'Linka…':'Genera ID per abilitare'}</button>
                ${id?`<a class="btn" href="linked.html?id=${encodeURIComponent(id)}" target="_blank" rel="noopener">Visualizza linked</a>`:`<button class="btn" disabled>Visualizza linked</button>`}
                ${id?`<button class="btn" data-details="${escapeAttr(id)}">Dettagli</button>`:`<button class="btn" disabled>Dettagli</button>`}
                ${id?`<button class="btn" data-collapse="${escapeAttr(id)}">${(collapsed.has(id)||collapseAll)?'Espandi':'Compatta'}</button>`:`<button class="btn" disabled>Compatta</button>`}
              </div>`;

            const openBtn=card.querySelector('[data-open-linker]'); if(openBtn) openBtn.onclick=()=>openLinkWidget(item);
            const detBtn =card.querySelector('[data-details]');   if(detBtn)  detBtn.onclick=()=>openDetail(item);
            const colBtn =card.querySelector('[data-collapse]');  if(colBtn)  colBtn.onclick=(e)=>toggleCollapsed(id,e.currentTarget,card);

            try{
              const tCol=typeColor(item.Type||'');
              card.style.setProperty('--type-color', tCol.solid);
              card.style.setProperty('--type-bg', tCol.bg);
              card.style.setProperty('--type-pill-bg', tCol.pillBg);
            }catch{}

            grid.appendChild(card);
          });

          box.appendChild(grid);
          container.appendChild(box);
        });
      }

      function toggleCollapsed(id, btn, itemEl){
        if(collapseAll){ collapseAll=false; collapsed.clear(); }
        else{ if(collapsed.has(id)) collapsed.delete(id); else collapsed.add(id); }
        if(itemEl){
          itemEl.classList.toggle('collapsed', collapsed.has(id));
          if(btn) btn.textContent = itemEl.classList.contains('collapsed') ? 'Espandi' : 'Compatta';
        }else{
          renderNotes();
        }
      }

      function toggleAllCollapsed(){
        collapseAll=!collapseAll;
        if(collapseAll){
          collapsed.clear();
          getFilteredNotes().forEach(n=>{ if(n.ID) collapsed.add(String(n.ID)); });
        }else{
          collapsed.clear();
        }
        renderNotes();
      }

      function openDetail(item){
        if(!item) return;
        el('detTitle').textContent = String(item.Title||'(senza titolo)');
        el('detId').textContent    = String(item.ID||'');
        el('detDoi').textContent   = String(item.DOI||'');
        el('detType').textContent  = String(item.Type||'');
        const pill=el('detTypePill'); if(pill) pill.textContent=String(item.Type||'');
        el('detTags').textContent  = String(item.Tags||'');
        el('detNote').textContent  = String(item.Note||'');
        el('detText').textContent  = String(item.Text||'');
        const link=String(item.Link||item.URL||'');
        el('detLink').innerHTML = link ? `<a href="${escapeAttr(link)}" target="_blank" rel="noopener">${escapeHtml(link)}</a>` : '';
        const img=String(item.ImageLink||''); const imgEl=el('detImg');
        if(img){ imgEl.src=img; imgEl.style.display='block'; imgEl.alt='Immagine '+String(item.ID||''); } else { imgEl.removeAttribute('src'); imgEl.style.display='none'; }
        try{
          const col=typeColor(item.Type||''); const sheet=document.querySelector('#detailOverlay .sheet');
          if(sheet){ sheet.style.setProperty('--type-color', col.solid); sheet.style.setProperty('--type-pill-bg', col.pillBg); }
        }catch{}
        el('detailOverlay').style.display='flex';
      }
      function closeDetail(){ const o=el('detailOverlay'); if(o) o.style.display='none'; }

      // Linker
      let linkOrigin=null, linkSelection=new Set();
      function openLinkWidget(item){
        if(!item||!item.ID) return;
        linkOrigin=item;
        linkSelection=new Set(String(item.LinkedIDs||'').split(',').map(s=>s.trim()).filter(Boolean));
        el('lwSourceId').textContent=String(item.ID);
        el('lwSearch').value=''; renderLinkList();
        el('linkOverlay').style.display='flex';
        setTimeout(()=>el('lwSearch')?.focus(),0);
        el('lwSearch').oninput=renderLinkList;
      }
      function closeLinkWidget(){
        el('linkOverlay').style.display='none';
        el('lwList').innerHTML=''; el('lwSelected').innerHTML=''; el('lwCount').textContent='0';
        linkOrigin=null; linkSelection.clear();
      }
      function renderLinkList(){
        const q=el('lwSearch').value.trim().toLowerCase();
        const list=el('lwList'); list.innerHTML='';
        state.notes.forEach(n=>{
          const id=String(n.ID||''); if(!id) return; if(linkOrigin && id===String(linkOrigin.ID)) return;
          const hay=[n.Title,n.Text,n.Tags,n.Note,n.ImageLink,n.Animal].map(x=>String(x||'').toLowerCase()).join(' ');
          if(q && !hay.includes(q)) return;
          const checked=linkSelection.has(id)?'checked':''; const animal=String(n.Animal||'').trim();
          const tagsHtml=((animal?`<span class="tag animal-tag">🐾 ${escapeHtml(animal)}</span> `:'')+String(n.Tags||'').split(',').map(t=>t.trim()).filter(Boolean).map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join(' ')).trim();
          const img=String(n.ImageLink||''); const imgHtml=img?`<img class="thumb" src="${escapeAttr(img)}" alt="img ${escapeAttr(id)}">`:``;
          const div=document.createElement('div'); div.className='lw-item';
          div.innerHTML=`
            <label style="display:grid;grid-template-columns:24px 96px 1fr;gap:10px;align-items:flex-start;">
              <input class="lw-check" type="checkbox" value="${escapeAttr(id)}" ${checked} style="margin-top:6px;">
              <div>${imgHtml}</div>
              <div>
                <div class="t clamp-2" style="font-weight:700">${escapeHtml(n.Title||'(senza titolo)')}</div>
                <div class="muted clamp-2">${escapeHtml(n.Text||'')}</div>
                ${n.Note?`<div class="muted"><b>Nota:</b> ${escapeHtml(n.Note)}</div>`:''}
                ${tagsHtml?`<div class="tags" style="margin-top:6px;">${tagsHtml}</div>`:''}
                <div class="muted" style="margin-top:6px;">ID: <code>${escapeHtml(id)}</code></div>
              </div>
            </label>`;
          list.appendChild(div);
        });
        list.onchange=(e)=>{
          const t=e.target;
          if(t && t.classList.contains('lw-check')){
            const id=String(t.value);
            if(t.checked) linkSelection.add(id); else linkSelection.delete(id);
            updateSelectedPreview();
          }
        };
        updateSelectedPreview();
      }
      function updateSelectedPreview(){
        const sel=Array.from(linkSelection);
        el('lwCount').textContent=String(sel.length);
        el('lwSelected').innerHTML=sel.map(id=>`<span class="pill">ID ${escapeHtml(id)}</span>`).join(' ');
      }
      async function confirmLink(){
        if(!linkOrigin||!linkOrigin.ID){ closeLinkWidget(); return; }
        const checked=Array.from(linkSelection);
        showToast('Invio dei link al server…','info',2000);
        try{
          const url=new URL(DEFAULT_APPS_URL);
          url.searchParams.set('mode','updateLinks');
          url.searchParams.set('id',String(linkOrigin.ID));
          url.searchParams.set('linkedIds',checked.join(','));
          const res=await jsonp(url.toString());
          if(!res||res.ok!==true){ showToast('Errore: risposta non valida dal server','err',5000); return; }
          await loadAll(); closeLinkWidget(); showToast('Link salvati sul server','ok',3500);
        }catch(err){ console.error('confirmLink error',err); showToast('Errore di rete durante il salvataggio','err',5000); }
      }

      // Export e utility
      const NOTES_HEADERS=['CreatedAt','URL','Link','Title','DOI','Text','Tags','Type','ClientTimestamp','ID','LinkedIDs','Note','ImageLink','Animal'];
      function exportNotesCsv(){
        const rows=getFilteredNotes(); const csv=toCsv(rows,NOTES_HEADERS);
        downloadCsv(csv,`notes_${timestamp()}.csv`);
      }

      function jsonp(baseUrl){
        return new Promise((resolve,reject)=>{
          try{
            const url=new URL(baseUrl); const cb='cb_'+Math.random().toString(36).slice(2);
            url.searchParams.set('callback',cb);
            const s=document.createElement('script'); let done=false;
            window[cb]=(data)=>{ done=true; cleanup(); resolve(data); };
            s.src=url.toString(); s.onerror=(e)=>{ cleanup(); reject(e); };
            document.body.appendChild(s);
            const t=setTimeout(()=>{ if(!done){ cleanup(); reject(new Error('JSONP timeout')); } },12000);
            function cleanup(){ try{ delete window[cb]; }catch{} try{ s.remove(); }catch{} clearTimeout(t); }
          }catch(err){ reject(err); }
        });
      }

      function showToast(message,kind='info',timeout=3000){
        try{
          const c=el('toastContainer'); if(!c) return alert(message);
          const elx=document.createElement('div'); elx.className='toast '+(kind||'info'); elx.textContent=String(message);
          c.appendChild(elx); const t=setTimeout(()=>{ try{ elx.remove(); }catch{} }, timeout||3000);
          elx.addEventListener('click',()=>{ clearTimeout(t); try{ elx.remove(); }catch{} });
        }catch(e){ console.warn('toast error',e); }
      }

      function groupBy(arr,keyFn){ return arr.reduce((acc,x)=>{ const k=keyFn(x); (acc[k] ||= []).push(x); return acc; },{}); }
      function toCsv(rows,headers){
        const esc=v=>'"'+String(v==null?'':v).replace(/"/g,'""')+'"';
        const lines=[headers.map(h=>'"'+h+'"').join(',')];
        for(const r of rows){ lines.push(headers.map(h=>esc(r[h])).join(',')); }
        return lines.join('\r\n');
      }
      function downloadCsv(text,filename){
        const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      }
      function timestamp(){ const d=new Date(); const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}-${p(d.getHours())}${p(d.getMinutes())}${p(d.getSeconds())}`; }
      function escapeHtml(str){ return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
      function escapeAttr(str){ return escapeHtml(str).replace(/"/g,'&quot;'); }
      function el(id){ return document.getElementById(id); }

      function hashHue(str){ const s=String(str||'').toLowerCase(); let h=0>>>0; for(let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))>>>0; } return h%360; }
      function typeColor(type){
        const h=hashHue(type);
        return { hue:h, solid:`hsl(${h}, 70%, 45%)`, bg:`hsl(${h}, 85%, 96%)`, pillBg:`hsl(${h}, 95%, 92%)` };
      }

      async function generateIds(){
        try{
          if(!confirm('Assegnare un ID alle note senza ID?')) return;
          const url=new URL(DEFAULT_APPS_URL); url.searchParams.set('mode','assignIds');
          const data=await jsonp(url.toString());
          const assigned=data&&typeof data.assigned==='number'?data.assigned:null;
          showToast(typeof assigned==='number'?`Assegnati ${assigned} ID`:'Assegnazione ID completata','ok',3500);
          await loadAll();
        }catch(e){ console.error('Errore generateIds',e); showToast('Errore durante la generazione degli ID','err',5000); }
      }
    </script>
  </body>
</html>
