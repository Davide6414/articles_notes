<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Article Note Saver - Dashboard</title>
    <style>
      :root {
        --bg: #f6f7fb;
        --panel: #ffffff;
        --muted: #64748b;
        --text: #0f172a;
        --accent: #2563eb;
        --accent2: #10b981;
        --ring: #93c5fd;
        --border: #e5e7eb;
        --border-strong: #cbd5e1;
      }
      * { box-sizing: border-box; transition: all .18s ease; }
      html, body { height: 100%; margin:0; }
      body {
        font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif;
        background: radial-gradient(1200px 800px at 20% -10%, #eef2ff 0%, #f8fafc 40%, var(--bg) 100%);
        color: var(--text); line-height: 1.55;
      }
      :focus-visible { outline: 3px solid var(--ring); outline-offset: 2px; border-radius: 10px; }

      .header {
        padding: 22px;
        border-bottom: 1px solid #dbeafe;
        background: linear-gradient(90deg, var(--accent) 0%, var(--accent2) 100%);
        color: #fff;
      }
      .header h1 { margin:0; font-size:24px; font-weight:800; }
      .tabs{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;}
      .tabs button{padding:10px 16px;border-radius:999px;background:#ffffff2b;color:#fff;border:1px solid #ffffff55;cursor:pointer;font-size:14px;}
      .tabs button.active{background:#fff;color:var(--accent);font-weight:700;}

      main { padding:24px 28px; }

      .filters{display:grid;grid-template-columns:1fr repeat(2,minmax(180px,240px)) auto auto auto;gap:12px;margin-bottom:20px;}
      .filters input,.filters select{padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:14px;}
      .filters button{padding:10px 14px;border-radius:10px;border:1px solid var(--border-strong);background:#fff;font-weight:600;cursor:pointer;}
      .filters #notesExportCsv,.filters #dataExportCsv{background:var(--accent);border-color:var(--accent);color:#fff;}

      .groups{display:flex;flex-direction:column;gap:22px;}
      .group{background:#fff;border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 1px 0 rgba(15,23,42,0.02),0 10px 24px -18px rgba(2,6,23,0.3);}
      .group h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:16px;font-weight:700;background:linear-gradient(90deg,var(--accent)0%,var(--accent2)100%);color:#fff;display:flex;justify-content:space-between;align-items:center;}
      .group h3 .meta{font-weight:600;font-size:12px;padding:2px 8px;background:#ffffff2b;border-radius:999px;}

      .items-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:12px;}
      .note-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);overflow:hidden;display:flex;flex-direction:column;}
      .note-card .thumb{width:100%;height:140px;object-fit:cover;}
      .note-card .card-body{padding:12px;display:flex;flex-direction:column;gap:6px;flex:1;}
      .note-card .type{font-size:12px;font-weight:800;padding:3px 6px;border-radius:6px;color:#fff;display:inline-block}
      .note-card .fulltext{font-size:15px;line-height:1.4}
      .note-card .note-highlight{background:#fff8c5;padding:6px 8px;border-radius:8px;font-size:15px;font-weight:500;}
      .note-card .tags{display:flex;gap:6px;flex-wrap:wrap}
      .note-card .tag{font-size:11px;background:#ecfeff;padding:3px 8px;border-radius:999px;border:1px solid #bae6fd}
      .actions-row{margin:0 12px 12px;display:flex;gap:8px;flex-wrap:wrap}
      .btn{padding:8px 14px;border-radius:10px;border:1px solid var(--border-strong);background:#fff;cursor:pointer;font-size:13px;font-weight:600;}
      .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}

      .overlay{position:fixed;inset:0;background:rgba(2,6,23,.52);display:none;align-items:center;justify-content:center;z-index:9999;}
      .sheet{width:min(880px,96vw);max-height:min(86vh,900px);overflow:auto;background:#fff;border-radius:16px;box-shadow:0 14px 40px rgba(2,6,23,.36);padding:18px;}
    </style>
  </head>
  <body>
    <header class="header">
      <h1>Article Note Saver - Dashboard</h1>
      <div class="tabs">
        <button id="tabNotes" class="active">Appunti</button>
        <button id="tabData">Dati</button>
      </div>
    </header>

    <main>
      <section id="notesPanel">
        <div class="filters">
          <input id="notesSearch" placeholder="Cerca testo / titolo" />
          <select id="notesTypeFilter"><option value="">Tutti i type</option></select>
          <select id="notesTagFilter"><option value="">Tutti i tag</option></select>
          <button id="notesExportCsv">Esporta CSV</button>
          <button id="toggleAllCollapseBtn">Toggle tutti</button>
        </div>
        <div id="notesGroups" class="groups"></div>
      </section>

      <section id="dataPanel" style="display:none;">
        <div class="filters">
          <input id="dataSearch" placeholder="Cerca per variabile" />
          <select id="dataVarFilter"><option value="">Tutte le variabili</option></select>
          <button id="dataExportCsv">Esporta CSV</button>
        </div>
        <div id="dataGroups" class="groups"></div>
      </section>
    </main>

    <div id="detailOverlay" class="overlay">
      <div class="sheet">
        <div class="hd">
          <b id="detTitle">(titolo)</b>
          <button class="btn" id="detCloseBtn">Chiudi</button>
        </div>
        <div id="detBody"></div>
      </div>
    </div>

    <script>
      const DEFAULT_APPS_URL="https://script.google.com/macros/s/AKfycbyRXsW2jhj_NarPEyX5T8Yqf8U05qrZtPWReMwC9oW4dHTqXegnZhUmCwuYVmMXZ1uX/exec";
      const state={ notes:[], data:[] };
      const collapsed=new Set(); let collapseAll=false;
      const typeColors=new Map();
      function getTypeColor(type){
        if(typeColors.has(type)) return typeColors.get(type);
        const hue=Math.floor(Math.random()*360);
        const color=`hsl(${hue},70%,45%)`;
        typeColors.set(type,color); return color;
      }

      document.addEventListener('DOMContentLoaded',()=>{
        document.getElementById('tabNotes').onclick=()=>switchTab('notes');
        document.getElementById('tabData').onclick=()=>switchTab('data');
        document.getElementById('notesSearch').oninput=renderNotes;
        document.getElementById('notesTypeFilter').onchange=renderNotes;
        document.getElementById('notesTagFilter').onchange=renderNotes;
        document.getElementById('dataSearch').oninput=renderData;
        document.getElementById('dataVarFilter').onchange=renderData;
        document.getElementById('notesExportCsv').onclick=()=>console.log('export notes',getFilteredNotes());
        document.getElementById('dataExportCsv').onclick=()=>console.log('export data',getFilteredData());
        document.getElementById('toggleAllCollapseBtn').onclick=toggleAllCollapsed;
        document.getElementById('detCloseBtn').onclick=closeDetail;
        loadAll();
      });

      async function loadAll(){
        try{
          const url=new URL(DEFAULT_APPS_URL); url.searchParams.set('mode','all');
          const res=await fetch(url); const json=await res.json();
          state.notes=Array.isArray(json.notes)?json.notes:[];
          state.data=Array.isArray(json.data)?json.data:[];
        }catch(e){ console.error(e); }
        populateFilters(); renderNotes(); renderData();
      }

      function switchTab(which){
        document.getElementById('notesPanel').style.display=(which==='notes')?'block':'none';
        document.getElementById('dataPanel').style.display=(which==='data')?'block':'none';
        document.getElementById('tabNotes').classList.toggle('active',which==='notes');
        document.getElementById('tabData').classList.toggle('active',which==='data');
      }

      function populateFilters(){
        const typeSet=new Set(); state.notes.forEach(n=>{ if(n.Type) typeSet.add(n.Type); });
        document.getElementById('notesTypeFilter').innerHTML='<option value="">Tutti i type</option>'+Array.from(typeSet).map(t=>`<option value="${t}">${t}</option>`).join('');
        const tagSet=new Set(); state.notes.forEach(n=>{ (n.Tags||'').split(',').forEach(t=>{ if(t.trim()) tagSet.add(t.trim()); }); });
        document.getElementById('notesTagFilter').innerHTML='<option value="">Tutti i tag</option>'+Array.from(tagSet).map(t=>`<option value="${t}">${t}</option>`).join('');
        const varSet=new Set(); state.data.forEach(d=>{ if(d.Variable) varSet.add(d.Variable); });
        document.getElementById('dataVarFilter').innerHTML='<option value="">Tutte le variabili</option>'+Array.from(varSet).map(v=>`<option value="${v}">${v}</option>`).join('');
      }

      function getFilteredNotes(){
        const search=document.getElementById('notesSearch').value.toLowerCase();
        const typeFilter=document.getElementById('notesTypeFilter').value;
        const tagFilter=document.getElementById('notesTagFilter').value;
        return state.notes.filter(n=>{
          if(typeFilter && n.Type!==typeFilter) return false;
          if(tagFilter && !(n.Tags||'').toLowerCase().includes(tagFilter.toLowerCase())) return false;
          if(!search) return true;
          return (n.Title||''+n.Text||''+n.Note||'').toLowerCase().includes(search);
        });
      }

      function renderNotes(){
        const filtered=getFilteredNotes();
        const groups=groupBy(filtered,n=>n.Title||'(senza titolo)');
        const container=document.getElementById('notesGroups'); container.innerHTML='';
        Object.keys(groups).forEach(title=>{
          const items=groups[title];
          const box=document.createElement('div'); box.className='group';
          box.innerHTML=`<h3>${title}<span class="meta">${items.length}</span></h3>`;
          const grid=document.createElement('div'); grid.className='items-grid';
          items.forEach(item=>{
            const id=item.ID||''; const tags=(item.Tags||'').split(',').map(t=>t.trim()).filter(Boolean);
            const link=item.Link||item.URL||''; const noteText=item.Note||''; const img=item.ImageLink||'';
            const card=document.createElement('div'); card.className='note-card';
            card.innerHTML=`
              ${img?`<img class="thumb" src="${img}">`:``}
              <div class="card-body">
                <span class="type" style="background:${getTypeColor(item.Type||'SENZA TIPO')}">${item.Type||'SENZA TIPO'}</span>
                <div class="fulltext">${item.Text||''}</div>
                ${tags.length?`<div class="tags">${tags.map(t=>`<span class="tag">${t}</span>`).join('')}</div>`:''}
                ${noteText?`<div class="note-highlight"><b>Nota:</b> ${noteText}</div>`:''}
                <div class="linkwrap">${link?`<a href="${link}" target="_blank">Apri sorgente</a>`:''}</div>
              </div>
              <div class="actions-row">
                ${link?`<a class="btn" href="${link}" target="_blank">Vai allâ€™articolo</a>`:''}
                <button class="btn" data-details="${id}">Dettagli</button>
              </div>`;
            const detBtn=card.querySelector('[data-details]'); if(detBtn) detBtn.onclick=()=>openDetail(item);
            grid.appendChild(card);
          });
          box.appendChild(grid); container.appendChild(box);
        });
      }

      function getFilteredData(){
        const search=document.getElementById('dataSearch').value.toLowerCase();
        const varFilter=document.getElementById('dataVarFilter').value;
        return state.data.filter(d=>{
          if(varFilter && d.Variable!==varFilter) return false;
          if(!search) return true;
          return (d.Title||''+d.Variable||''+d.Notes||'').toLowerCase().includes(search);
        });
      }

      function renderData(){
        const filtered=getFilteredData();
        const groups=groupBy(filtered,d=>d.Title||'(senza titolo)');
        const container=document.getElementById('dataGroups'); container.innerHTML='';
        Object.keys(groups).forEach(title=>{
          const box=document.createElement('div'); box.className='group';
          box.innerHTML=`<h3>${title}<span class="meta">${groups[title].length}</span></h3>`;
          const grid=document.createElement('div'); grid.className='items-grid';
          groups[title].forEach(item=>{
            const card=document.createElement('div'); card.className='note-card';
            card.innerHTML=`<div class="card-body">
              <b>${item.Value||''} ${item.Unit||''}</b>
              <div>${item.Notes||''}</div>
            </div>`;
            grid.appendChild(card);
          });
          box.appendChild(grid); container.appendChild(box);
        });
      }

      function openDetail(item){
        if(!item) return;
        document.getElementById('detTitle').textContent=item.Title||'(senza titolo)';
        document.getElementById('detBody').textContent=item.Text||'';
        document.getElementById('detailOverlay').style.display='flex';
      }
      function closeDetail(){ document.getElementById('detailOverlay').style.display='none'; }

      function groupBy(arr,keyFn){ return arr.reduce((acc,x)=>{ const k=keyFn(x); (acc[k] ||= []).push(x); return acc; },{}); }
      function toggleAllCollapsed(){ collapseAll=!collapseAll; renderNotes(); }
    </script>
  </body>
</html>
