<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Article Note Saver - Dashboard</title>
    <style>
      :root { --bg:#0b0c10; --panel:#15171c; --muted:#9aa0a6; --text:#e8eaed; --accent:#4fc3f7; }
      * { box-sizing: border-box; }
      body { margin:0; font-family: system-ui, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
      .header { padding:16px; border-bottom:1px solid #222; }
      .header h1 { margin:0 0 12px; font-size:20px; }
      .controls { display:flex; gap:8px; align-items:center; margin-bottom:12px; }
      .controls input { flex:1; padding:8px; border-radius:6px; border:1px solid #333; background:#0f1115; color:var(--text); }
      .controls button { padding:8px 12px; border:0; border-radius:6px; background:var(--accent); color:#001018; font-weight:600; cursor:pointer; }
      .tabs { display:flex; gap:8px; }
      .tabs button { padding:6px 12px; border-radius:6px; background:#0f1115; color:var(--text); border:1px solid #333; cursor:pointer; }
      .tabs button.active { background:var(--accent); color:#001018; border-color:transparent; }
      main { padding:16px; }
      .filters { display:flex; gap:8px; margin-bottom:12px; flex-wrap: wrap; }
      .filters input, .filters select { padding:8px; border-radius:6px; border:1px solid #333; background:#0f1115; color:var(--text); }
      .filters button { padding:8px 12px; border:0; border-radius:6px; background:var(--accent); color:#001018; font-weight:600; cursor:pointer; }
      .groups { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:12px; }
      .group { background:var(--panel); border:1px solid #222; border-radius:10px; overflow:hidden; }
      .group h3 { margin:0; padding:10px 12px; border-bottom:1px solid #222; font-size:14px; background:#0f1115; }
      .item { padding:10px 12px; border-top:1px dashed #2a2d34; font-size:13px; }
      .item:first-child { border-top:0; }
      .item a { color:#88d1ff; text-decoration: none; }
      .meta { color:var(--muted); font-size:12px; margin-top:4px; }
      .tags { margin-top:6px; display:flex; gap:6px; flex-wrap: wrap; }
      .tag { font-size:11px; color:#001018; background:#8be1ff; padding:2px 6px; border-radius:10px; }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>Article Note Saver - Dashboard</h1>
      <div class="controls">
        <label>Apps Script URL</label>
        <input id="appsUrl" placeholder="https://script.google.com/macros/s/XXX/exec" />
        <button id="loadBtn">Carica</button>
        <button id="generateIdsBtn" title="Assegna ID alle note senza ID">Genera ID mancanti</button>
      </div>
      <div class="tabs">
        <button id="tabNotes" class="active">Appunti</button>
        <button id="tabData">Dati</button>
      </div>
    </header>

    <main>
      <section id="notesPanel">
        <div class="filters">
          <input id="notesSearch" placeholder="Cerca testo/titolo/DOI" />
          <select id="notesTypeFilter">
            <option value="">Tutti i type</option>
          </select>
          <select id="notesTagFilter">
            <option value="">Tutti i tag</option>
          </select>
          <button id="notesExportCsv" title="Esporta gli appunti filtrati in CSV">Esporta CSV</button>
        </div>
        <div id="notesGroups" class="groups"></div>
      </section>

      <section id="dataPanel" style="display:none;">
        <div class="filters">
          <input id="dataSearch" placeholder="Cerca per variabile/DOI" />
          <select id="dataVarFilter">
            <option value="">Tutte le variabili</option>
          </select>
          <button id="dataExportCsv" title="Esporta i dati filtrati in CSV">Esporta CSV</button>
        </div>
        <div id="dataGroups" class="groups"></div>
      </section>
    </main>

    <script>
      // Config: aggiorna con la tua URL di Apps Script (stessa usata dall'estensione)
      const DEFAULT_APPS_URL = "https://script.google.com/macros/s/AKfycbyRXsW2jhj_NarPEyX5T8Yqf8U05qrZtPWReMwC9oW4dHTqXegnZhUmCwuYVmMXZ1uX/exec";

      const state = {
        appsUrl: '',
        notes: [],
        data: []
      };

      document.addEventListener('DOMContentLoaded', () => {
        const appsUrlEl = document.getElementById('appsUrl');
        const loadBtn = document.getElementById('loadBtn');
        const tabNotes = document.getElementById('tabNotes');
        const tabData = document.getElementById('tabData');
        const notesExportBtn = document.getElementById('notesExportCsv');
        const genIdsBtn = document.getElementById('generateIdsBtn');
        const dataExportBtn = document.getElementById('dataExportCsv');

        appsUrlEl.value = localStorage.getItem('appsUrl') || DEFAULT_APPS_URL;
        state.appsUrl = appsUrlEl.value;

        loadBtn.onclick = async () => {
          state.appsUrl = appsUrlEl.value.trim();
          localStorage.setItem('appsUrl', state.appsUrl);
          await loadAll();
        };
        genIdsBtn.onclick = async () => {
          try {
            const res = await fetch(state.appsUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json; charset=UTF-8' },
              body: JSON.stringify({ mode: 'assignIds' })
            });
            const txt = await res.text();
            alert('Assegnazione ID completata: ' + txt);
            await loadAll();
          } catch (e) {
            console.error(e);
            alert('Errore durante assegnazione ID');
          }
        };
        tabNotes.onclick = () => switchTab('notes');
        tabData.onclick = () => switchTab('data');

        // Filters
        document.getElementById('notesSearch').oninput = renderNotes;
        document.getElementById('notesTypeFilter').onchange = renderNotes;
        document.getElementById('notesTagFilter').onchange = renderNotes;
        document.getElementById('dataSearch').oninput = renderData;
        document.getElementById('dataVarFilter').onchange = renderData;
        notesExportBtn.onclick = exportNotesCsv;
        dataExportBtn.onclick = exportDataCsv;

        loadAll();
      });

      async function loadAll() {
        try {
          const url = new URL(state.appsUrl);
          url.searchParams.set('mode', 'all');
          const res = await fetch(url.toString());
          const json = await res.json();
          state.notes = Array.isArray(json.notes) ? json.notes : [];
          state.data = Array.isArray(json.data) ? json.data : [];
          populateFilters();
          renderNotes();
          renderData();
        } catch (e) {
          console.error('Errore caricamento dati:', e);
          alert('Errore nel recupero dati. Verifica la URL di Apps Script.');
        }
      }

      function switchTab(which) {
        const nBtn = document.getElementById('tabNotes');
        const dBtn = document.getElementById('tabData');
        const nPanel = document.getElementById('notesPanel');
        const dPanel = document.getElementById('dataPanel');
        if (which === 'data') {
          nBtn.classList.remove('active');
          dBtn.classList.add('active');
          nPanel.style.display = 'none';
          dPanel.style.display = '';
        } else {
          dBtn.classList.remove('active');
          nBtn.classList.add('active');
          dPanel.style.display = 'none';
          nPanel.style.display = '';
        }
      }

      function populateFilters() {
        // Types for notes
        const typeSet = new Set();
        state.notes.forEach(n => { if (n.Type) typeSet.add(String(n.Type)); });
        const typeSel = document.getElementById('notesTypeFilter');
        typeSel.innerHTML = '<option value="">Tutti i type</option>' +
          Array.from(typeSet).sort().map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

        // Tags for notes
        const tagSet = new Set();
        state.notes.forEach(n => {
          const raw = String(n.Tags || '').split(',');
          raw.forEach(t => { const v = t.trim(); if (v) tagSet.add(v); });
        });
        const tagSel = document.getElementById('notesTagFilter');
        tagSel.innerHTML = '<option value="">Tutti i tag</option>' +
          Array.from(tagSet).sort((a,b)=>a.localeCompare(b,'it',{sensitivity:'base'})).map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

        // Variables for data
        const varSet = new Set();
        state.data.forEach(d => { if (d.Variable) varSet.add(String(d.Variable)); });
        const varSel = document.getElementById('dataVarFilter');
        varSel.innerHTML = '<option value="">Tutte le variabili</option>' +
          Array.from(varSet).sort().map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      }

      function getFilteredNotes() {
        const search = document.getElementById('notesSearch').value.trim().toLowerCase();
        const typeFilter = document.getElementById('notesTypeFilter').value;
        const tagFilter = document.getElementById('notesTagFilter').value;
        return state.notes.filter(n => {
          if (typeFilter && String(n.Type) !== typeFilter) return false;
          if (tagFilter) {
            const tags = String(n.Tags || '').split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
            if (!tags.includes(tagFilter.toLowerCase())) return false;
          }
          if (!search) return true;
          const hay = [n.Title, n.DOI, n.Text, n.URL, n.Link, n.Tags].map(x => String(x||'').toLowerCase()).join(' ');
          return hay.includes(search);
        });
      }

      function getFilteredData() {
        const search = document.getElementById('dataSearch').value.trim().toLowerCase();
        const varFilter = document.getElementById('dataVarFilter').value;
        return state.data.filter(d => {
          if (varFilter && String(d.Variable) !== varFilter) return false;
          if (!search) return true;
          const hay = [d.Variable, d.DOI, d.URL, d.Notes, d.Unit].map(x => String(x||'').toLowerCase()).join(' ');
          return hay.includes(search);
        });
      }

      function renderNotes() {
        const filtered = getFilteredNotes();
        const groups = groupBy(filtered, x => String(x.Type || 'Senza tipo'));
        const container = document.getElementById('notesGroups');
        container.innerHTML = '';
        Object.keys(groups).sort().forEach(type => {
          const box = document.createElement('div');
          box.className = 'group';
          box.innerHTML = `<h3>${escapeHtml(type)} <span class="meta">(${groups[type].length})</span></h3>`;
          groups[type].forEach(item => {
            const link = String(item.Link || item.URL || '');
            const a = link ? `<a href="${escapeAttr(link)}" target="_blank">Apri</a>` : '';
            const div = document.createElement('div');
            const tags = String(item.Tags || '').split(',').map(t => t.trim()).filter(Boolean);
            div.className = 'item';
            const id = String(item.ID || '');
            const linked = String(item.LinkedIDs || '');
            div.innerHTML = `
              <div><b>${escapeHtml(String(item.Title||''))}</b></div>
              <div class="meta">DOI: ${escapeHtml(String(item.DOI||''))}</div>
              <div>${escapeHtml(String(item.Text||''))}</div>
              ${tags.length ? `<div class="tags">${tags.map(t=>`<span class=\"tag\">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
              <div class="meta">${a}</div>
              <div class="meta">ID: <code>${escapeHtml(id)}</code> <button data-copy-id>copia</button></div>
              <div class="meta">Linked IDs:</div>
              <div style="display:flex; gap:6px; align-items:center; margin-top:6px;">
                <input data-linked style="flex:1; padding:6px; border-radius:6px; border:1px solid #333; background:#0f1115; color:var(--text);" value="${escapeAttr(linked)}" placeholder="uuid1, uuid2" />
                <button data-save-links>Salva</button>
              </div>
            `;
            // wire actions
            const copyBtn = div.querySelector('[data-copy-id]');
            if (copyBtn) copyBtn.onclick = async () => { try { await navigator.clipboard.writeText(id); copyBtn.textContent='copiato'; setTimeout(()=>copyBtn.textContent='copia',1200);} catch(e){} };
            const input = div.querySelector('[data-linked]');
            const saveBtn = div.querySelector('[data-save-links]');
            if (saveBtn) saveBtn.onclick = async () => {
              try {
                const body = { mode: 'updateLinks', id, linkedIds: input.value };
                const res = await fetch(state.appsUrl, { method:'POST', headers:{'Content-Type':'application/json; charset=UTF-8'}, body: JSON.stringify(body)});
                const txt = await res.text();
                console.log('Update links:', txt);
                await loadAll();
              } catch (e) {
                console.error('Errore update links', e);
                alert('Errore salvataggio collegamenti');
              }
            };
            box.appendChild(div);
          });
          container.appendChild(box);
        });
      }

      function renderData() {
        const filtered = getFilteredData();
        const groups = groupBy(filtered, x => String(x.Variable || 'Senza variabile'));
        const container = document.getElementById('dataGroups');
        container.innerHTML = '';
        Object.keys(groups).sort().forEach(variable => {
          const box = document.createElement('div');
          box.className = 'group';
          box.innerHTML = `<h3>${escapeHtml(variable)} <span class="meta">(${groups[variable].length})</span></h3>`;
          groups[variable].forEach(item => {
            const link = String(item.Link || item.URL || '');
            const a = link ? `<a href="${escapeAttr(link)}" target="_blank">Apri</a>` : '';
            const val = String(item.Value||'');
            const unit = String(item.Unit||'');
            const mean = String(item.Mean||'');
            const std = String(item.StdDev||'');
            const n = String(item.N||'');
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
              <div><b>${escapeHtml(val)} ${escapeHtml(unit)}</b> <span class="meta">N=${escapeHtml(n)} mean=${escapeHtml(mean)} sd=${escapeHtml(std)}</span></div>
              <div class="meta">DOI: ${escapeHtml(String(item.DOI||''))}</div>
              <div>${escapeHtml(String(item.Notes||''))}</div>
              <div class="meta">${a}</div>
            `;
            box.appendChild(div);
          });
          container.appendChild(box);
        });
      }

      function groupBy(arr, keyFn) {
        return arr.reduce((acc, x) => {
          const k = keyFn(x);
          (acc[k] ||= []).push(x);
          return acc;
        }, {});
      }

      // --- Export CSV ---
      const NOTES_HEADERS = [
        'CreatedAt','URL','Link','Title','DOI','Text','Tags','Type','ClientTimestamp','ID','LinkedIDs'
      ];
      const DATA_HEADERS = [
        'CreatedAt','DOI','URL','Link','Variable','Value','Unit','N','Mean','StdDev','Notes','ClientTimestamp'
      ];

      function exportNotesCsv() {
        const rows = getFilteredNotes();
        const csv = toCsv(rows, NOTES_HEADERS);
        downloadCsv(csv, `notes_${timestamp()}.csv`);
      }
      function exportDataCsv() {
        const rows = getFilteredData();
        const csv = toCsv(rows, DATA_HEADERS);
        downloadCsv(csv, `data_${timestamp()}.csv`);
      }

      function toCsv(rows, headers) {
        const esc = v => '"' + String(v == null ? '' : v).replace(/"/g, '""') + '"';
        const lines = [headers.map(h => '"' + h + '"').join(',')];
        for (const r of rows) {
          lines.push(headers.map(h => esc(r[h])).join(','));
        }
        return lines.join('\r\n');
      }

      function downloadCsv(text, filename) {
        const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function timestamp() {
        const d = new Date();
        const pad = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
      }
      function escapeAttr(str) {
        return escapeHtml(str).replace(/"/g, '&quot;');
      }
    </script>
  </body>
  </html>
