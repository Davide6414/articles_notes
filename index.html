<!doctype html>
<html lang="it">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Article Note Saver - Dashboard</title>
    <style>
      :root { 
        --bg:#fdfdfd; 
        --panel:#ffffff; 
        --muted:#556b6f; 
        --text:#1a2b2c; 
        --accent:#2e8b57; 
        --accent2:#1e90ff;
      }
      * { box-sizing: border-box; transition: all 0.2s ease-in-out; }
      body { margin:0; font-family: system-ui, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--text); }
      .header { padding:20px; border-bottom:2px solid #cde; background:linear-gradient(90deg, var(--accent) 0%, var(--accent2) 100%); color:white; }
      .header h1 { margin:0; font-size:22px; font-weight:600; }
      .tabs { display:flex; gap:10px; margin-top:12px; }
      .tabs button { padding:8px 14px; border-radius:8px; background:#ffffff33; color:#fff; border:1px solid #ffffff55; cursor:pointer; }
      .tabs button.active { background:#fff; color:var(--accent); font-weight:600; }
      main { padding:20px; }
      .filters { display:flex; gap:10px; margin-bottom:14px; flex-wrap: wrap; }
      .filters input, .filters select { padding:8px; border-radius:6px; border:1px solid #aac; background:#f0f8ff; color:var(--text); }
      .filters button { padding:8px 14px; border:0; border-radius:6px; background:var(--accent2); color:white; font-weight:600; cursor:pointer; }
      .groups { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:16px; }
      .group { background:var(--panel); border:1px solid #ccd; border-radius:12px; overflow:hidden; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
      .group:hover { transform:scale(1.02); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
      .group h3 { margin:0; padding:12px; border-bottom:1px solid #dde; font-size:15px; background:var(--accent); color:white; }
      .item { padding:12px; border-top:1px dashed #ccd; font-size:13px; }
      .item:first-child { border-top:0; }
      .item a { color:var(--accent2); text-decoration: none; font-weight:600; }
      .item a:hover { text-decoration: underline; }
      .meta { color:var(--muted); font-size:12px; margin-top:4px; }
      .tags { margin-top:6px; display:flex; gap:6px; flex-wrap: wrap; }
      .tag { font-size:11px; color:white; background:var(--accent2); padding:3px 7px; border-radius:10px; }
      /* Link widget */
      .overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:99999; }
      .link-widget { width: min(1000px, 95vw); height:min(70vh, 720px); background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 10px 30px rgba(0,0,0,0.3); display:grid; grid-template-columns: 1fr 1fr; }
      .lw-header { grid-column: 1 / span 2; padding:10px 12px; background:linear-gradient(90deg, var(--accent), var(--accent2)); color:#fff; display:flex; align-items:center; gap:8px; }
      .lw-header b { flex:1; }
      .lw-left { border-right:1px solid #e5ecf0; padding:10px; overflow:auto; }
      .lw-right { padding:10px; overflow:auto; display:flex; flex-direction:column; justify-content:space-between; }
      .lw-search { width:100%; padding:8px; border:1px solid #cbd5e1; border-radius:8px; }
      .lw-item { border-bottom:1px solid #eef3f6; padding:8px; cursor:pointer; }
      .lw-item:hover { background:#f7fafc; }
      .lw-item .t { color:#1f2937; font-weight:600; }
      .lw-item .m { color:#6b7280; font-size:12px; margin-top:4px; }
      .lw-actions { display:flex; gap:8px; margin-top:10px; }
      .btn { padding:8px 12px; border-radius:8px; border:1px solid #cbd5e1; background:#fff; cursor:pointer; }
      .btn.primary { background:var(--accent2); color:#fff; border-color:var(--accent2); }
    </style>
  </head>
  <body>
    <header class="header">
      <h1>Article Note Saver - Dashboard</h1>
      <div class="tabs">
        <button id="tabNotes" class="active">Appunti</button>
        <button id="tabData">Dati</button>
      </div>
    </header>

    <main>
      <section id="notesPanel">
        <div class="filters">
          <input id="notesSearch" placeholder="Cerca testo/titolo/DOI" />
          <select id="notesTypeFilter">
            <option value="">Tutti i type</option>
          </select>
          <select id="notesTagFilter">
            <option value="">Tutti i tag</option>
          </select>
          <button id="notesExportCsv" title="Esporta gli appunti filtrati in CSV">Esporta CSV</button>
          <button id="generateIdsBtn" title="Assegna ID alle note senza ID">Genera ID</button>
        </div>
        <div id="notesGroups" class="groups"></div>
      </section>

      <section id="dataPanel" style="display:none;">
        <div class="filters">
          <input id="dataSearch" placeholder="Cerca per variabile/DOI" />
          <select id="dataVarFilter">
            <option value="">Tutte le variabili</option>
          </select>
          <button id="dataExportCsv" title="Esporta i dati filtrati in CSV">Esporta CSV</button>
        </div>
        <div id="dataGroups" class="groups"></div>
      </section>
    </main>

    <!-- Overlay per linking -->
    <div id="linkOverlay" class="overlay" style="display:none;">
      <div class="link-widget">
        <div class="lw-header">
          <b>Seleziona note da linkare</b>
          <button class="btn" onclick="closeLinkWidget()">Chiudi</button>
        </div>
        <div class="lw-left">
          <input id="lwSearch" class="lw-search" placeholder="Cerca noteâ€¦" />
          <div id="lwList"></div>
        </div>
        <div class="lw-right">
          <div id="lwSelected"></div>
          <div class="lw-actions">
            <button class="btn" onclick="closeLinkWidget()">Annulla</button>
            <button class="btn primary" onclick="confirmLink()">Linka</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const DEFAULT_APPS_URL = "https://script.google.com/macros/s/AKfycbyRXsW2jhj_NarPEyX5T8Yqf8U05qrZtPWReMwC9oW4dHTqXegnZhUmCwuYVmMXZ1uX/exec";

      const state = { notes: [], data: [] };

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('tabNotes').onclick = () => switchTab('notes');
        document.getElementById('tabData').onclick = () => switchTab('data');

        document.getElementById('notesSearch').oninput = renderNotes;
        document.getElementById('notesTypeFilter').onchange = renderNotes;
        document.getElementById('notesTagFilter').onchange = renderNotes;
        document.getElementById('dataSearch').oninput = renderData;
        document.getElementById('dataVarFilter').onchange = renderData;
        document.getElementById('notesExportCsv').onclick = exportNotesCsv;
        const genBtn = document.getElementById('generateIdsBtn');
        if (genBtn) genBtn.onclick = generateIds;
        document.getElementById('dataExportCsv').onclick = exportDataCsv;

        loadAll();
      });

      async function loadAll() {
        try {
          const url = new URL(DEFAULT_APPS_URL);
          url.searchParams.set('mode', 'all');
          const res = await fetch(url.toString());
          const json = await res.json();
          state.notes = Array.isArray(json.notes) ? json.notes : [];
          state.data = Array.isArray(json.data) ? json.data : [];
          populateFilters();
          renderNotes();
          renderData();
        } catch (e) {
          try {
            const url = new URL(DEFAULT_APPS_URL);
            url.searchParams.set('mode', 'all');
            const data = await jsonp(url.toString());
            state.notes = Array.isArray(data.notes) ? data.notes : [];
            state.data = Array.isArray(data.data) ? data.data : [];
            populateFilters();
            renderNotes();
            renderData();
          } catch (e2) {
            console.error('Errore caricamento dati:', e2);
            alert('Errore nel recupero dati dal server.');
          }
        }
      }

      function switchTab(which) {
        const nBtn = document.getElementById('tabNotes');
        const dBtn = document.getElementById('tabData');
        const nPanel = document.getElementById('notesPanel');
        const dPanel = document.getElementById('dataPanel');
        if (which === 'data') {
          nBtn.classList.remove('active');
          dBtn.classList.add('active');
          nPanel.style.display = 'none';
          dPanel.style.display = '';
        } else {
          dBtn.classList.remove('active');
          nBtn.classList.add('active');
          dPanel.style.display = 'none';
          nPanel.style.display = '';
        }
      }

      function populateFilters() {
        const typeSet = new Set();
        state.notes.forEach(n => { if (n.Type) typeSet.add(String(n.Type)); });
        const typeSel = document.getElementById('notesTypeFilter');
        typeSel.innerHTML = '<option value="">Tutti i type</option>' +
          Array.from(typeSet).sort().map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

        const tagSet = new Set();
        state.notes.forEach(n => {
          const raw = String(n.Tags || '').split(',');
          raw.forEach(t => { const v = t.trim(); if (v) tagSet.add(v); });
        });
        const tagSel = document.getElementById('notesTagFilter');
        tagSel.innerHTML = '<option value="">Tutti i tag</option>' +
          Array.from(tagSet).sort((a,b)=>a.localeCompare(b,'it',{sensitivity:'base'})).map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');

        const varSet = new Set();
        state.data.forEach(d => { if (d.Variable) varSet.add(String(d.Variable)); });
        const varSel = document.getElementById('dataVarFilter');
        varSel.innerHTML = '<option value="">Tutte le variabili</option>' +
          Array.from(varSet).sort().map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
      }

      function getFilteredNotes() {
        const search = document.getElementById('notesSearch').value.trim().toLowerCase();
        const typeFilter = document.getElementById('notesTypeFilter').value;
        const tagFilter = document.getElementById('notesTagFilter').value;
        return state.notes.filter(n => {
          if (typeFilter && String(n.Type) !== typeFilter) return false;
          if (tagFilter) {
            const tags = String(n.Tags || '').split(',').map(t => t.trim().toLowerCase()).filter(Boolean);
            if (!tags.includes(tagFilter.toLowerCase())) return false;
          }
          if (!search) return true;
          const hay = [n.Title, n.DOI, n.Text, n.URL, n.Link, n.Tags].map(x => String(x||'').toLowerCase()).join(' ');
          return hay.includes(search);
        });
      }

      function getFilteredData() {
        const search = document.getElementById('dataSearch').value.trim().toLowerCase();
        const varFilter = document.getElementById('dataVarFilter').value;
        return state.data.filter(d => {
          if (varFilter && String(d.Variable) !== varFilter) return false;
          if (!search) return true;
          const hay = [d.Variable, d.DOI, d.URL, d.Notes, d.Unit].map(x => String(x||'').toLowerCase()).join(' ');
          return hay.includes(search);
        });
      }

      function renderNotes() {
        const filtered = getFilteredNotes();
        const groups = groupBy(filtered, x => String(x.DOI || 'Senza DOI'));
        const container = document.getElementById('notesGroups');
        container.innerHTML = '';

        Object.keys(groups).sort().forEach(doi => {
          const items = groups[doi];
          const title = items[0].Title || doi || 'Senza titolo';
          const box = document.createElement('div');
          box.className = 'group';
          box.innerHTML = `<h3>${escapeHtml(title)} <span class="meta">(${items.length})</span></h3>`;

          items.forEach(item => {
            const link = String(item.Link || item.URL || '');
            const a = link ? `<a href="${escapeAttr(link)}" target="_blank">Apri</a>` : '';
            const tags = String(item.Tags || '').split(',').map(t => t.trim()).filter(Boolean);
            const div = document.createElement('div');
            div.className = 'item';
            const id = String(item.ID || '');
            const linked = String(item.LinkedIDs || '');
            div.innerHTML = `
              <div><b>Sezione: ${escapeHtml(String(item.Type || 'Senza tipo'))}</b></div>
              <div class="meta">DOI: ${escapeHtml(String(item.DOI||''))}</div>
              <div>${escapeHtml(String(item.Text||''))}</div>
              ${tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>` : ''}
              <div class="meta">${a}</div>
              <div class="meta">ID: <code>${escapeHtml(id || '(manca)')}</code></div>
              <div class="meta">Linked IDs: ${escapeHtml(linked)}</div>
              <div class="meta" style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                <button class="btn" data-open-linker ${id?'':'disabled'}>${id? 'Linkaâ€¦' : 'Genera ID per abilitare'}</button>
              </div>
            `;
            const openBtn = div.querySelector('[data-open-linker]');
            if (openBtn) openBtn.onclick = () => openLinkWidget(item);
            box.appendChild(div);
          });

          container.appendChild(box);
        });
      }

      function renderData() {
        const filtered = getFilteredData();
        const groups = groupBy(filtered, x => String(x.Variable || 'Senza variabile'));
        const container = document.getElementById('dataGroups');
        container.innerHTML = '';
        Object.keys(groups).sort().forEach(variable => {
          const box = document.createElement('div');
          box.className = 'group';
          box.innerHTML = `<h3>${escapeHtml(variable)} <span class="meta">(${groups[variable].length})</span></h3>`;
          groups[variable].forEach(item => {
            const link = String(item.Link || item.URL || '');
            const a = link ? `<a href="${escapeAttr(link)}" target="_blank">Apri</a>` : '';
            const val = String(item.Value||'');
            const unit = String(item.Unit||'');
            const mean = String(item.Mean||'');
            const std = String(item.StdDev||'');
            const n = String(item.N||'');
            const div = document.createElement('div');
            div.className = 'item';
            div.innerHTML = `
              <div><b>${escapeHtml(val)} ${escapeHtml(unit)}</b> <span class="meta">N=${escapeHtml(n)} mean=${escapeHtml(mean)} sd=${escapeHtml(std)}</span></div>
              <div class="meta">DOI: ${escapeHtml(String(item.DOI||''))}</div>
              <div>${escapeHtml(String(item.Notes||''))}</div>
              <div class="meta">${a}</div>
            `;
            box.appendChild(div);
          });
          container.appendChild(box);
        });
      }

      function groupBy(arr, keyFn) {
        return arr.reduce((acc, x) => {
          const k = keyFn(x);
          (acc[k] ||= []).push(x);
          return acc;
        }, {});
      }

      const NOTES_HEADERS = [
        'CreatedAt','URL','Link','Title','DOI','Text','Tags','Type','ClientTimestamp'
      ];
      const DATA_HEADERS = [
        'CreatedAt','DOI','URL','Link','Variable','Value','Unit','N','Mean','StdDev','Notes','ClientTimestamp'
      ];

      function exportNotesCsv() {
        const rows = getFilteredNotes();
        const csv = toCsv(rows, NOTES_HEADERS);
        downloadCsv(csv, `notes_${timestamp()}.csv`);
      }
      function exportDataCsv() {
        const rows = getFilteredData();
        const csv = toCsv(rows, DATA_HEADERS);
        downloadCsv(csv, `data_${timestamp()}.csv`);
      }

      function toCsv(rows, headers) {
        const esc = v => '"' + String(v == null ? '' : v).replace(/"/g, '""') + '"';
        const lines = [headers.map(h => '"' + h + '"').join(',')];
        for (const r of rows) {
          lines.push(headers.map(h => esc(r[h])).join(','));
        }
        return lines.join('\r\n');
      }

      function downloadCsv(text, filename) {
        const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function timestamp() {
        const d = new Date();
        const pad = n => String(n).padStart(2, '0');
        return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}-${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
      }

      function escapeHtml(str) {
        return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
      }
      function escapeAttr(str) {
        return escapeHtml(str).replace(/"/g, '&quot;');
      }

      async function generateIds() {
        try {
          if (!confirm('Assegnare un ID alle note senza ID?')) return;
          const url = new URL(DEFAULT_APPS_URL);
          url.searchParams.set('mode', 'assignIds');
          const data = await jsonp(url.toString());
          const assigned = data && typeof data.assigned === 'number' ? data.assigned : null;
          alert(typeof assigned === 'number' ? `Assegnati ${assigned} ID` : 'Assegnazione ID completata');
          await loadAll();
        } catch (e) {
          console.error('Errore generateIds', e);
          alert('Errore durante la generazione degli ID');
        }
      }

      function jsonp(baseUrl) {
        return new Promise((resolve, reject) => {
          try {
            const url = new URL(baseUrl);
            const cbName = 'cb_' + Math.random().toString(36).slice(2);
            url.searchParams.set('callback', cbName);
            const s = document.createElement('script');
            let done = false;
            window[cbName] = (data) => { done = true; cleanup(); resolve(data); };
            s.src = url.toString();
            s.onerror = (e) => { cleanup(); reject(e); };
            document.body.appendChild(s);
            const t = setTimeout(() => { if (!done) { cleanup(); reject(new Error('JSONP timeout')); } }, 10000);
            function cleanup(){ try{ delete window[cbName]; }catch{} try{ s.remove(); }catch{} clearTimeout(t); }
          } catch (err) { reject(err); }
        });
      }

      // ---- Link widget logic ----
      let linkOrigin = null;

      function openLinkWidget(item){
        linkOrigin = item;
        document.getElementById('linkOverlay').style.display = 'flex';
        renderLinkList();
        document.getElementById('lwSearch').oninput = renderLinkList;
      }

      function closeLinkWidget(){
        document.getElementById('linkOverlay').style.display = 'none';
        linkOrigin = null;
      }

      function renderLinkList(){
        const q = document.getElementById('lwSearch').value.trim().toLowerCase();
        const list = document.getElementById('lwList');
        list.innerHTML = '';
        state.notes.forEach(n=>{
          if(n.ID===linkOrigin.ID) return;
          const hay = [n.Title,n.Text,n.Tags].map(x=>String(x||'').toLowerCase()).join(' ');
          if(q && !hay.includes(q)) return;
          const div = document.createElement('div');
          div.className='lw-item';
          div.innerHTML = `
            <label style="display:flex;gap:6px;align-items:flex-start;">
              <input type="checkbox" value="${escapeAttr(n.ID||'')}">
              <div>
                <div class="t">${escapeHtml(n.Title||'(senza titolo)')}</div>
                <div class="m">${escapeHtml(n.Text||'')}</div>
                <div class="tags">${String(n.Tags||'').split(',').map(t=>`<span class="tag">${escapeHtml(t.trim())}</span>`).join('')}</div>
              </div>
            </label>`;
          list.appendChild(div);
        });
      }

      function confirmLink(){
        const checked=[...document.querySelectorAll('#lwList input[type=checkbox]:checked')]
          .map(c=>c.value).filter(Boolean);
        if(linkOrigin){
          linkOrigin.LinkedIDs = checked.join(',');
          renderNotes();
        }
        closeLinkWidget();
      }
    </script>
  </body>
</html>
