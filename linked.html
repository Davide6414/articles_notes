<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Linked Notes – Mindmap</title>
  <style>
    :root{
      --bg:#0b1220; --grid:#111827; --panel:#0f172a; --text:#e5eef8; --muted:#93a3b5;
      --accent:#2e8b57; --accent2:#1e90ff; --edge:#6aa2ff55; --node:#1f2937; --nodeBorder:#334155;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:radial-gradient(1200px 1200px at 30% 10%, #0f1a2f 0%, #0b1220 45%, #070d18 100%); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Arial}
    header{position:fixed;left:0;right:0;top:0;z-index:10;display:flex;gap:8px;align-items:center;padding:10px 12px;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 2px 10px #0007}
    header b{font-weight:700}
    header .sp{flex:1}
    header input,header select{padding:8px 10px;border:1px solid #ffffff66;border-radius:8px;background:#ffffff22;color:#fff;min-width:260px}
    header .btn{padding:8px 12px;border-radius:8px;border:1px solid #fff8;background:#fff0;color:#fff;cursor:pointer}
    header .btn.primary{background:#fff;color:#1b2b3c;font-weight:700}
    #main{position:absolute; inset:56px 0 0 0; overflow:hidden}
    /* stage (pan/zoom) */
    #viewport{width:100%;height:100%;position:relative;cursor:grab}
    #viewport.grabbing{cursor:grabbing}
    #stage{position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(1); transform-origin:50% 50%}
    /* edges */
    #edges{position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none}
    /* nodes */
    #nodes{position:absolute; left:0; top:0}
    .node{position:absolute; transform:translate(-50%,-50%); background:linear-gradient(180deg,#0f172a,#0b1424); border:1px solid var(--nodeBorder); border-radius:14px; padding:10px; width:220px; box-shadow:0 8px 24px #0008}
    .node.center{border:1px solid #fff; box-shadow:0 12px 28px #000c}
    .node .title{font-weight:700; font-size:14px; line-height:1.2}
    .node .meta{color:var(--muted); font-size:12px; margin-top:6px}
    .node .tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .node .tag{font-size:11px;background:#1e293b;color:#dbe5f2;border:1px solid #324256;padding:2px 6px;border-radius:10px}
    .node .note{margin-top:8px; font-size:12px; color:#d8e7ff}
    .thumb{width:100%; height:110px; object-fit:cover; border-radius:10px; border:1px solid #22314a; margin-top:8px; background:#0b1528}
    .noimg{width:100%; height:110px; border-radius:10px; border:1px dashed #22314a; display:flex; align-items:center; justify-content:center; font-size:12px; color:#8ba1bf; margin-top:8px}
    .node .actions{display:flex;gap:8px;margin-top:10px}
    .node .btn{padding:6px 8px; font-size:12px; border-radius:8px; border:1px solid #2b3b56; background:#0e1a2d; color:#e6f0ff; cursor:pointer}
    .node .btn:hover{border-color:#5b7bb6}
    line.edge{stroke:var(--edge); stroke-width:2}
    .legend{position:fixed;left:12px;bottom:12px;background:#0c1528dd;border:1px solid #24334d;border-radius:10px;padding:8px 10px;font-size:12px;color:#cfe1ff}
    /* toast */
    .toastc{position:fixed; top:64px; right:16px; display:flex; flex-direction:column; gap:8px; z-index:99}
    .toast{min-width:220px; max-width:360px; background:#0e172a; border:1px solid #2a3b55; border-left:4px solid #1e90ff; box-shadow:0 8px 18px #0008; padding:8px 10px; border-radius:10px; font-size:13px}
    .toast.ok{border-left-color:#16a34a}
    .toast.err{border-left-color:#dc2626}
  </style>
</head>
<body>
  <header>
    <b>Mindmap Linked Notes</b>
    <div class="sp"></div>
    <input id="search" placeholder="Cerca per titolo/testo/tag/ID…" />
    <button class="btn" id="pickBtn" title="Scegli nota come centro">Scegli</button>
    <button class="btn primary" id="recenterBtn" title="Torna alla nota centrale">Re-centra</button>
    <a class="btn" id="backBtn" href="./" title="Torna alla dashboard">Dashboard</a>
  </header>

  <div id="main">
    <div id="viewport">
      <div id="stage">
        <svg id="edges"></svg>
        <div id="nodes"></div>
      </div>
    </div>
  </div>

  <div class="legend">Mouse: trascina per muovere | Rotellina: zoom | Clic su nodo: re-centra</div>
  <div class="toastc" id="toastc"></div>

  <script>
    // ----- CONFIG -----
    const DEFAULT_APPS_URL = "https://script.google.com/macros/s/AKfycbyRXsW2jhj_NarPEyX5T8Yqf8U05qrZtPWReMwC9oW4dHTqXegnZhUmCwuYVmMXZ1uX/exec";

    // ----- STATE -----
    const state = { notes: [], indexById:new Map(), centerId:null, layout:{scale:1, tx:0, ty:0} };

    // ----- INIT -----
    document.addEventListener('DOMContentLoaded', async () => {
      bindUI();
      await loadAll();
      const qp = new URLSearchParams(location.search);
      const startId = qp.get('id');
      const start = state.indexById.has(startId) ? startId : (state.notes.find(n=>n.ID)||{}).ID;
      if (!start) { toast('Nessuna nota disponibile','err'); return; }
      setCenter(start);
      layoutAndRender();
    });

    function bindUI(){
      document.getElementById('pickBtn').onclick = pickFromSearch;
      document.getElementById('recenterBtn').onclick = ()=>{ if(state.centerId){ setCenter(state.centerId); layoutAndRender(); }};
      document.getElementById('search').addEventListener('keydown', e=>{ if(e.key==='Enter') pickFromSearch(); });
      // pan/zoom
      const vp = document.getElementById('viewport');
      let dragging=false, sx=0, sy=0, stx=0, sty=0;
      vp.addEventListener('mousedown', e=>{ if(e.button!==0) return; dragging=true; sx=e.clientX; sy=e.clientY; stx=state.layout.tx; sty=state.layout.ty; vp.classList.add('grabbing'); });
      window.addEventListener('mouseup', ()=>{ dragging=false; vp.classList.remove('grabbing'); });
      window.addEventListener('mousemove', e=>{ if(!dragging) return; state.layout.tx = stx + (e.clientX - sx); state.layout.ty = sty + (e.clientY - sy); applyTransform(); });
      vp.addEventListener('wheel', e=>{
        e.preventDefault();
        const scaleFactor = Math.exp(-e.deltaY * 0.001);
        const prev = state.layout.scale;
        const next = Math.min(3, Math.max(0.3, prev*scaleFactor));
        // zoom to cursor
        const rect = vp.getBoundingClientRect();
        const cx = e.clientX - rect.left - rect.width/2 - state.layout.tx;
        const cy = e.clientY - rect.top - rect.height/2 - state.layout.ty;
        state.layout.tx -= cx*(next/prev -1);
        state.layout.ty -= cy*(next/prev -1);
        state.layout.scale = next;
        applyTransform();
      }, {passive:false});
    }

    function applyTransform(){
      const st = document.getElementById('stage');
      st.style.transform = `translate(calc(-50% + ${state.layout.tx}px), calc(-50% + ${state.layout.ty}px)) scale(${state.layout.scale})`;
    }

    // ----- DATA LOAD -----
    async function loadAll(){
      try{
        const url = new URL(DEFAULT_APPS_URL);
        url.searchParams.set('mode','all');
        const res = await fetch(url.toString());
        const json = await res.json();
        state.notes = Array.isArray(json.notes) ? json.notes : [];
      }catch(_){
        // JSONP fallback
        const url = new URL(DEFAULT_APPS_URL);
        url.searchParams.set('mode','all');
        const data = await jsonp(url.toString());
        state.notes = Array.isArray(data.notes) ? data.notes : [];
      }
      // normalize + index
      state.notes.forEach(n=>{
        n.ID = String(n.ID||'').trim();
        n.LinkedIDs = String(n.LinkedIDs||'').trim();
        n.Title = String(n.Title||'');
        n.Text = String(n.Text||'');
        n.Tags = String(n.Tags||'');
        n.Note = String(n.Note||'');
        n.ImageLink = String(n.ImageLink||'');
        state.indexById.set(n.ID, n);
      });
    }

    // ----- GRAPH BUILDING -----
    function neighborsOf(id){
      if(!id) return [];
      const out = new Set();
      // forward
      const src = state.indexById.get(id);
      if (src && src.LinkedIDs){
        normalizeIdList(src.LinkedIDs).forEach(x=> out.add(x));
      }
      // backlinks
      state.notes.forEach(n=>{
        if (!n.ID || n.ID===id) return;
        if (normalizeIdList(n.LinkedIDs).includes(id)) out.add(n.ID);
      });
      // drop invalids
      return Array.from(out).filter(x=>state.indexById.has(x));
    }

    function setCenter(id){
      state.centerId = id;
    }

    // ----- LAYOUT + RENDER -----
    function layoutAndRender(){
      const center = state.indexById.get(state.centerId);
      const nbrs = neighborsOf(state.centerId);

      const nodesContainer = document.getElementById('nodes');
      const edgesSvg = document.getElementById('edges');
      nodesContainer.innerHTML = '';
      edgesSvg.innerHTML = '';

      // stage size to cover positions
      edgesSvg.setAttribute('width', 3000);
      edgesSvg.setAttribute('height', 3000);

      // positions
      const positions = new Map(); // id -> {x,y}
      positions.set(center.ID, {x:0, y:0});

      const R = Math.max(180, Math.min(window.innerWidth, window.innerHeight)*0.36);
      const k = Math.max(1, nbrs.length);
      nbrs.forEach((nid, i)=>{
        const a = (i/k)*Math.PI*2;
        positions.set(nid, { x: R*Math.cos(a), y: R*Math.sin(a) });
      });

      // edges from center to neighbors
      nbrs.forEach(nid=>{
        const a = positions.get(center.ID), b = positions.get(nid);
        const line = document.createElementNS('http://www.w3.org/2000/svg','line');
        line.setAttribute('class','edge');
        line.setAttribute('x1', a.x + 1500); line.setAttribute('y1', a.y + 1500);
        line.setAttribute('x2', b.x + 1500); line.setAttribute('y2', b.y + 1500);
        edgesSvg.appendChild(line);
      });

      // render nodes
      renderNode(center, positions.get(center.ID), true, nodesContainer);
      nbrs.forEach(nid=>{
        renderNode(state.indexById.get(nid), positions.get(nid), false, nodesContainer);
      });
    }

    function renderNode(n, pos, isCenter, container){
      const el = document.createElement('div');
      el.className = 'node' + (isCenter ? ' center' : '');
      el.style.left = (pos.x + 1500) + 'px';
      el.style.top  = (pos.y + 1500) + 'px';

      const tags = String(n.Tags||'').split(',').map(t=>t.trim()).filter(Boolean);
      const tagsHtml = tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">${escapeHtml(t)}</span>`).join('')}</div>` : '';
      const noteHtml = n.Note ? `<div class="note"><b>Nota:</b> ${escapeHtml(n.Note)}</div>` : '';
      const imgHtml  = n.ImageLink ? `<img class="thumb" src="${escapeAttr(n.ImageLink)}" alt="img ${escapeAttr(n.ID)}">`
                                    : `<div class="noimg">nessuna immagine</div>`;

      el.innerHTML = `
        <div class="title">${escapeHtml(n.Title || '(senza titolo)')}</div>
        <div class="meta">ID: <code>${escapeHtml(n.ID)}</code>${n.DOI?` &middot; DOI: <code>${escapeHtml(n.DOI)}</code>`:''}</div>
        <div class="meta">${escapeHtml(n.Text||'')}</div>
        ${tagsHtml}
        ${noteHtml}
        ${imgHtml}
        <div class="actions">
          ${n.Link||n.URL ? `<a class="btn" target="_blank" href="${escapeAttr(n.Link||n.URL)}">Apri</a>`:''}
          ${!isCenter ? `<button class="btn" data-recenter="${escapeAttr(n.ID)}">Centrale</button>`:''}
          <button class="btn" data-copyid="${escapeAttr(n.ID)}">Copia ID</button>
        </div>
      `;

      // actions
      el.addEventListener('click', (e)=>{
        const rec = e.target.closest('[data-recenter]');
        if (rec){
          const nid = rec.getAttribute('data-recenter');
          setCenter(nid); layoutAndRender(); return;
        }
        const cp = e.target.closest('[data-copyid]');
        if (cp){
          const nid = cp.getAttribute('data-copyid');
          navigator.clipboard?.writeText(nid);
          toast('ID copiato','ok');
        }
      });

      container.appendChild(el);
    }

    // ----- SEARCH / PICK -----
    function pickFromSearch(){
      const q = document.getElementById('search').value.trim().toLowerCase();
      if (!q) { toast('Inserisci un termine','err'); return; }
      // match by ID exact first, else fuzzy in title/text/tags/note
      if (state.indexById.has(q)){ setCenter(q); layoutAndRender(); return; }
      const hit = state.notes.find(n=>{
        const hay = [n.Title,n.Text,n.Tags,n.Note,n.ID].map(x=>String(x||'').toLowerCase()).join(' ');
        return hay.includes(q);
      });
      if (!hit){ toast('Nessuna nota trovata','err'); return; }
      setCenter(hit.ID); layoutAndRender();
    }

    // ----- HELPERS -----
    function normalizeIdList(s){
      return String(s||'').split(/[\s,;]+/).map(x=>x.trim()).filter(Boolean);
    }
    function escapeHtml(str){return String(str).replace(/[&<>"']/g, s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}
    function escapeAttr(str){return escapeHtml(str).replace(/"/g,'&quot;')}
    function toast(msg, kind='info', t=2500){
      const c = document.getElementById('toastc');
      const el = document.createElement('div'); el.className='toast '+(kind||'info'); el.textContent=msg;
      c.appendChild(el); setTimeout(()=>{ try{ el.remove(); }catch{} }, t);
      el.addEventListener('click', ()=>{ try{ el.remove(); }catch{} });
    }
    function jsonp(baseUrl){
      return new Promise((resolve,reject)=>{
        try{
          const url = new URL(baseUrl); const cb='cb_'+Math.random().toString(36).slice(2);
          url.searchParams.set('callback', cb);
          const s=document.createElement('script'); let done=false;
          window[cb]=(data)=>{ done=true; cleanup(); resolve(data); };
          s.src=url.toString(); s.onerror=(e)=>{ cleanup(); reject(e); };
          document.body.appendChild(s);
          const t=setTimeout(()=>{ if(!done){ cleanup(); reject(new Error('JSONP timeout')); } },12000);
          function cleanup(){ try{ delete window[cb]; }catch{} try{ s.remove(); }catch{} clearTimeout(t); }
        }catch(err){ reject(err); }
      });
    }
  </script>
</body>
</html>
